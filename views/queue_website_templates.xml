<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- À ajouter dans le <head> de vos templates ou dans un template parent -->
    <template id="queue_assets_common" name="Queue Assets">
        <link rel="stylesheet" href="/queue_management/static/src/css/queue_scroll_fix.css"/>
        <script src="/queue_management/static/src/js/queue_scroll_manager.js"></script>
    </template>
    <!-- ========================================
         TEMPLATES PRINCIPAUX
         ======================================== -->
    
    <!-- Template principal d'accueil -->
    <template id="queue_home_template" name="Files d'Attente - Accueil">
        <t t-call="website.layout">
            <!-- Appel des assets -->
            <t t-call="queue_management.queue_assets_common"/>
            <div id="wrap" class="oe_structure oe_empty">
                <div class="container mt-4">
                    <div class="row">
                        <div class="col-12">
                            <div class="text-center mb-4">
                                <h1 class="display-4">Files d'Attente</h1>
                                <p class="lead text-muted">Prenez votre ticket et suivez votre position</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <t t-foreach="services" t-as="service">
                            <div class="col-md-6 col-lg-4 mb-4">
                                <div class="card h-100 shadow-sm">
                                    <div class="card-header bg-primary text-white">
                                        <h5 class="card-title mb-0">
                                            <i class="fa fa-users me-2"></i>
                                            <t t-esc="service.name"/>
                                        </h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="row text-center mb-3">
                                            <div class="col-6">
                                                <div class="h3 text-warning mb-0">
                                                    <t t-esc="service.waiting_count or 0"/>
                                                </div>
                                                <small class="text-muted">En attente</small>
                                            </div>
                                            <div class="col-6">
                                                <div class="h3 text-info mb-0">
                                                    <t t-esc="round(service.avg_waiting_time, 0) or 0"/>min
                                                </div>
                                                <small class="text-muted">Temps moyen</small>
                                            </div>
                                        </div>
                                        
                                        <t t-if="service.description">
                                            <p class="card-text text-muted small">
                                                <t t-esc="service.description"/>
                                            </p>
                                        </t>
                                        
                                        <div class="d-grid">
                                            <t t-if="service.is_open">
                                                <form method="post" action="/queue/take_ticket_http" class="d-grid">
                                                    <input type="hidden" name="service_id" t-att-value="service.id"/>
                                                    <button type="submit" class="btn btn-success btn-lg">
                                                        <i class="fa fa-ticket me-2"></i>
                                                        Prendre un ticket
                                                    </button>
                                                </form>
                                            </t>
                                            <t t-else="">
                                                <button class="btn btn-secondary btn-lg disabled">
                                                    <i class="fa fa-clock me-2"></i>
                                                    Service fermé
                                                </button>
                                            </t>
                                        </div>
                                    </div>


                                    <!-- Horaires formatés améliorés -->
                                    <div class="mt-2 text-center">
                                        <small class="text-muted d-flex align-items-center justify-content-center">
                                            <i class="fa fa-clock-o me-1"/>
                                            <span>
                                                <!-- Formatage conditionnel des horaires -->
                                                <t t-if="service.working_hours_start and service.working_hours_end">
                                                    <!-- Format pour heures complètes (ex: 8:00 - 17:30) -->
                                                    <t t-set="start_hour" t-value="int(service.working_hours_start)"/>
                                                    <t t-set="start_minute" t-value="int((service.working_hours_start % 1) * 60)"/>
                                                    <t t-set="end_hour" t-value="int(service.working_hours_end)"/>
                                                    <t t-set="end_minute" t-value="int((service.working_hours_end % 1) * 60)"/>
                                                    
                                                    <t t-esc="'%02d:%02d' % (start_hour, start_minute)"/> - 
                                                    <t t-esc="'%02d:%02d' % (end_hour, end_minute)"/>
                                                </t>
                                                <t t-else="">
                                                    Horaires non définis
                                                </t>
                                            </span>
                                        </small>
                                    </div>
                                    
                                    <div class="card-footer bg-light">
                                        <small class="text-muted">
                                            <t t-if="service.is_open">
                                                <i class="fa fa-circle text-success me-1"></i>
                                                Ouvert
                                            </t>
                                            <t t-else="">
                                                <i class="fa fa-circle text-danger me-1"></i>
                                                Fermé
                                            </t>
                                            
                                            <t t-if="service.current_ticket_number">
                                                | Ticket actuel: #<t t-esc="service.current_ticket_number"/>
                                            </t>
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </t>
                    </div>
                    
                    <!-- Section navigation -->
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h5>Autres actions</h5>
                                    <div class="btn-group" role="group">
                                        <a href="/queue/search" class="btn btn-outline-primary">
                                            <i class="fa fa-search me-2"></i>
                                            Rechercher mon ticket
                                        </a>
                                        <a href="/queue/admin" class="btn btn-outline-info" 
                                           t-if="request.env.user.has_group('base.group_user')">
                                            <i class="fa fa-cog me-2"></i>
                                            Administration
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Section information -->
                    <div class="row mt-5">
                        <div class="col-12">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h5><i class="fa fa-question-circle text-info"/> Comment ça marche ?</h5>
                                    <div class="row">
                                        <div class="col-md-3 text-center mb-3">
                                            <i class="fa fa-mouse-pointer fa-2x text-primary mb-2"/>
                                            <h6>1. Choisissez</h6>
                                            <small>Sélectionnez votre service</small>
                                        </div>
                                        <div class="col-md-3 text-center mb-3">
                                            <i class="fa fa-ticket fa-2x text-info mb-2"/>
                                            <h6>2. Prenez</h6>
                                            <small>Obtenez votre ticket</small>
                                        </div>
                                        <div class="col-md-3 text-center mb-3">
                                            <i class="fa fa-clock-o fa-2x text-warning mb-2"/>
                                            <h6>3. Attendez</h6>
                                            <small>Suivez votre position</small>
                                        </div>
                                        <div class="col-md-3 text-center mb-3">
                                            <i class="fa fa-check fa-2x text-success mb-2"/>
                                            <h6>4. Présentez-vous</h6>
                                            <small>Quand vous êtes appelé(e)</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </t>
    </template>

    <!-- ========================================
         TEMPLATES DE CONFIRMATION ET SUIVI
         ======================================== -->
    
    <!-- Template de confirmation de ticket -->
    <template id="ticket_confirmation_template" name="Confirmation de Ticket">
        <t t-call="website.layout">
            <!-- Appel des assets -->
            <t t-call="queue_management.queue_assets_common"/>
            <div id="wrap" class="oe_structure oe_empty">
                <div class="container mt-4">
                    <div class="row justify-content-center">
                        <div class="col-md-8 col-lg-6">
                            <div class="card border-success">
                                <div class="card-header bg-success text-white text-center">
                                    <h4 class="mb-0">
                                        <i class="fa fa-check-circle me-2"></i>
                                        Ticket créé avec succès!
                                    </h4>
                                </div>
                                
                                <div class="card-body text-center">
                                    <!-- Informations principales -->
                                    <div class="mb-4">
                                        <h2 class="display-4 text-primary mb-2">
                                            #<t t-esc="ticket.ticket_number"/>
                                        </h2>
                                        
                                        <t t-if="reference">
                                            <div class="badge bg-info fs-6 mb-2">
                                                Réf: <t t-esc="reference"/>
                                            </div>
                                        </t>
                                        
                                        <t t-if="short_reference">
                                            <div class="badge bg-secondary fs-6 mb-2">
                                                Code: <t t-esc="short_reference"/>
                                            </div>
                                        </t>
                                        
                                        <h5 class="text-muted">
                                            <t t-esc="service.name"/>
                                        </h5>
                                    </div>
                                    
                                    <!-- Statistiques -->
                                    <div class="row text-center mb-4">
                                        <div class="col-4">
                                            <div class="h3 text-warning mb-1">
                                                <t t-esc="position"/>
                                            </div>
                                            <small class="text-muted">Position</small>
                                        </div>
                                        <div class="col-4">
                                            <div class="h3 text-info mb-1">
                                                <t t-esc="ticket.estimated_wait_time or (position * 5)"/>min
                                            </div>
                                            <small class="text-muted">Attente estimée</small>
                                        </div>
                                        <div class="col-4">
                                            <div class="h3 text-success mb-1">
                                                <t t-if="ticket.state == 'waiting'">En attente</t>
                                                <t t-if="ticket.state == 'called'">Appelé</t>
                                                <t t-if="ticket.state == 'serving'">En Service</t>
                                                <t t-if="ticket.state == 'served'">Servi</t>
                                                <t t-if="ticket.state == 'cancelled'">Annulé</t>
                                                <t t-if="ticket.state == 'no_show'">Absent</t>
                                            </div>
                                            <small class="text-muted">État</small>
                                        </div>
                                    </div>
                                    
                                    <!-- QR Code -->
                                    <div class="mb-4">
                                        <img t-att-src="'https://api.qrserver.com/v1/create-qr-code/?size=150x150&amp;data=' + request.httprequest.host_url + track_url.lstrip('/')"
                                             alt="QR Code" class="img-fluid" style="max-width: 150px;"/>
                                        <p class="small text-muted mt-2">
                                            Scannez ce code pour suivre votre ticket
                                        </p>
                                    </div>
                                    
                                    <!-- Actions -->
                                    <div class="d-grid gap-2">
                                        <a t-att-href="track_url" class="btn btn-primary">
                                            <i class="fa fa-eye me-2"></i>
                                            Suivre mon ticket
                                        </a>
                                        
                                        <a t-att-href="print_url + '?auto_print=1'" 
                                           target="_blank" class="btn btn-outline-secondary">
                                            <i class="fa fa-print me-2"></i>
                                            Imprimer le ticket
                                        </a>
                                    </div>
                                </div>
                                
                                <div class="card-footer bg-light">
                                    <small class="text-muted">
                                        <i class="fa fa-info-circle me-1"></i>
                                        Conservez cette référence pour suivre votre ticket
                                        <t t-if="reference">: <strong><t t-esc="reference"/></strong></t>
                                    </small>
                                </div>
                            </div>
                            
                            <div class="text-center mt-3">
                                <a href="/queue" class="btn btn-link">
                                    <i class="fa fa-arrow-left me-1"></i>
                                    Retour à l'accueil
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </t>
    </template>
    
    <!-- Template de suivi de ticket -->
    <template id="my_ticket_template" name="Suivi de Ticket">
        <t t-call="website.layout">
            <!-- Appel des assets -->
            <t t-call="queue_management.queue_assets_common"/>
            <div id="wrap" class="oe_structure oe_empty">
                <div class="container mt-4">
                    <div class="row justify-content-center">
                        <div class="col-md-8 col-lg-6">
                            <div class="card">
                                <div class="card-header bg-primary text-white text-center">
                                    <h4 class="mb-0">
                                        <i class="fa fa-ticket me-2"></i>
                                        Suivi de Ticket
                                    </h4>
                                </div>
                                
                                <div class="card-body text-center">
                                    <!-- Informations principales -->
                                    <div class="mb-4">
                                        <h1 class="display-3 text-primary mb-2">
                                            #<t t-esc="ticket.ticket_number"/>
                                        </h1>
                                        
                                        <t t-if="reference">
                                            <div class="badge bg-info fs-6 mb-2">
                                                <t t-esc="reference"/>
                                            </div>
                                        </t>
                                        
                                        <h5 class="text-muted mb-3">
                                            <t t-esc="service.name"/>
                                        </h5>
                                        
                                        <!-- État du ticket -->
                                        <div class="mb-3">
                                            <t t-if="ticket.state == 'waiting'">
                                                <span class="badge bg-warning fs-6">
                                                    <i class="fa fa-clock me-1"></i>En attente
                                                </span>
                                            </t>
                                            <t t-elif="ticket.state == 'called'">
                                                <span class="badge bg-success fs-6 animate__animated animate__pulse animate__infinite">
                                                    <i class="fa fa-bell me-1"></i>Appelé - Présentez-vous!
                                                </span>
                                            </t>
                                            <t t-elif="ticket.state == 'served'">
                                                <span class="badge bg-success fs-6">
                                                    <i class="fa fa-check me-1"></i>Servi
                                                </span>
                                            </t>
                                            <t t-elif="ticket.state == 'cancelled'">
                                                <span class="badge bg-danger fs-6">
                                                    <i class="fa fa-times me-1"></i>Annulé
                                                </span>
                                            </t>
                                        </div>
                                    </div>
                                    
                                    <!-- Statistiques -->
                                    <t t-if="ticket.state in ['waiting', 'called']">
                                        <div class="row text-center mb-4">
                                            <div class="col-6">
                                                <div class="h2 text-warning mb-1">
                                                    <t t-esc="position"/>
                                                </div>
                                                <small class="text-muted">Position dans la file</small>
                                            </div>
                                            <div class="col-6">
                                                <div class="h2 text-info mb-1">
                                                    <t t-esc="ticket.estimated_wait_time or (position * 5)"/>min
                                                </div>
                                                <small class="text-muted">Temps estimé</small>
                                            </div>
                                        </div>
                                        
                                        <!-- Barre de progression -->
                                        <div class="mb-4">
                                            <div class="progress" style="height: 10px;">
                                                <div class="progress-bar bg-success" 
                                                     t-att-style="'width: ' + str(max(10, 100 - (position * 10))) + '%'">
                                                </div>
                                            </div>
                                            <small class="text-muted">Progression dans la file</small>
                                        </div>
                                    </t>
                                    
                                    <!-- Informations client -->
                                    <t t-if="ticket.customer_name or ticket.customer_phone">
                                        <div class="card bg-light mb-3">
                                            <div class="card-body">
                                                <h6 class="card-title">Informations</h6>
                                                <t t-if="ticket.customer_name">
                                                    <p class="mb-1"><strong>Nom:</strong> <t t-esc="ticket.customer_name"/></p>
                                                </t>
                                                <t t-if="ticket.customer_phone">
                                                    <p class="mb-1"><strong>Téléphone:</strong> <t t-esc="ticket.customer_phone"/></p>
                                                </t>
                                            </div>
                                        </div>
                                    </t>
                                    
                                    <!-- Actions -->
                                    <div class="d-grid gap-2">
                                        <button onclick="location.reload()" class="btn btn-primary">
                                            <i class="fa fa-refresh me-2"></i>
                                            Actualiser
                                        </button>
                                        
                                        <t t-if="ticket.state in ['waiting', 'called'] and can_cancel">
                                            <a t-att-href="'/queue/cancel/' + reference if reference else '/queue/cancel_ticket_form/' + str(ticket.id)"
                                               class="btn btn-outline-danger">
                                                <i class="fa fa-times me-2"></i>
                                                Annuler mon ticket
                                            </a>
                                        </t>
                                        
                                        <t t-if="ticket.state == 'served'">
                                            <a t-att-href="'/queue/feedback/' + reference if reference else '/queue/feedback/' + str(ticket.id)"
                                               class="btn btn-outline-success">
                                                <i class="fa fa-star me-2"></i>
                                                Donner mon avis
                                            </a>
                                        </t>
                                    </div>
                                </div>
                                
                                <div class="card-footer bg-light">
                                    <div class="row text-center">
                                        <div class="col-6">
                                            <small class="text-muted">
                                                Créé le: <t t-esc="ticket.created_time.strftime('%d/%m/%Y à %H:%M') if ticket.created_time else ''"/>
                                            </small>
                                        </div>
                                        <div class="col-6">
                                            <small class="text-muted">
                                                Service: <t t-esc="service.name"/>
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="text-center mt-3">
                                <a href="/queue" class="btn btn-link">
                                    <i class="fa fa-home me-1"></i>
                                    Retour à l'accueil
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Auto-refresh pour les tickets en attente -->
            <t t-if="ticket.state in ['waiting', 'called']">
                <script>
                    setTimeout(function() {
                        location.reload();
                    }, 30000); // Actualisation toutes les 30 secondes
                </script>
            </t>
        </t>
    </template>

    <!-- ========================================
         TEMPLATES DE RECHERCHE ET ERREUR
         ======================================== -->
    
    <!-- Template de recherche de ticket -->
    <template id="search_ticket_template" name="Rechercher un Ticket">
        <t t-call="website.layout">
            <!-- Appel des assets -->
            <t t-call="queue_management.queue_assets_common"/>
            <div id="wrap" class="oe_structure oe_empty">
                <div class="container mt-4">
                    <div class="row justify-content-center">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-primary text-white text-center">
                                    <h4 class="mb-0">
                                        <i class="fa fa-search me-2"></i>
                                        Rechercher mon ticket
                                    </h4>
                                </div>
                                
                                <div class="card-body">
                                    <form method="post" action="/queue/search">
                                        <div class="mb-3">
                                            <label for="search_query" class="form-label">
                                                Référence du ticket ou numéro
                                            </label>
                                            <input type="text" 
                                                   class="form-control form-control-lg text-center" 
                                                   id="search_query" 
                                                   name="search_query" 
                                                   placeholder="Ex: QUE-2024-001-ABC ou #123"
                                                   required="required"
                                                   autofocus="autofocus"/>
                                            <div class="form-text">
                                                Saisissez la référence complète ou le code court de votre ticket
                                            </div>
                                        </div>
                                        
                                        <div class="d-grid">
                                            <button type="submit" class="btn btn-primary btn-lg">
                                                <i class="fa fa-search me-2"></i>
                                                Rechercher
                                            </button>
                                        </div>
                                    </form>
                                    
                                    <!-- Affichage des erreurs -->
                                    <t t-if="error">
                                        <div class="alert alert-danger mt-3">
                                            <i class="fa fa-exclamation-triangle me-2"></i>
                                            <t t-esc="error"/>
                                        </div>
                                    </t>
                                    
                                    <!-- Affichage des tickets multiples -->
                                    <t t-if="multiple_tickets">
                                        <div class="mt-3">
                                            <h5>Plusieurs tickets trouvés :</h5>
                                            <div class="list-group">
                                                <t t-foreach="multiple_tickets" t-as="ticket">
                                                    <a t-att-href="'/queue/track/' + ticket.ticket_reference if ticket.ticket_reference else '/queue/my_ticket/' + str(ticket.ticket_number) + '/' + str(ticket.service_id.id)"
                                                       class="list-group-item list-group-item-action">
                                                        <div class="d-flex w-100 justify-content-between">
                                                            <h6 class="mb-1">
                                                                #<t t-esc="ticket.ticket_number"/> - <t t-esc="ticket.service_id.name"/>
                                                            </h6>
                                                            <small class="text-muted">
                                                                <t t-esc="ticket.created_time.strftime('%d/%m/%Y %H:%M') if ticket.created_time else ''"/>
                                                            </small>
                                                        </div>
                                                        <t t-if="ticket.ticket_reference">
                                                            <small class="text-muted">Réf: <t t-esc="ticket.ticket_reference"/></small>
                                                        </t>
                                                    </a>
                                                </t>
                                            </div>
                                        </div>
                                    </t>
                                </div>
                                
                                <div class="card-footer bg-light text-center">
                                    <small class="text-muted">
                                        <i class="fa fa-info-circle me-1"></i>
                                        Vous trouverez la référence sur votre ticket imprimé
                                    </small>
                                </div>
                            </div>
                            
                            <div class="text-center mt-3">
                                <a href="/queue" class="btn btn-link">
                                    <i class="fa fa-arrow-left me-1"></i>
                                    Retour à l'accueil
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </t>
    </template>
    
    <!-- Template d'erreur générique -->
    <template id="error_template" name="Erreur">
        <t t-call="website.layout">
            <!-- Appel des assets -->
            <t t-call="queue_management.queue_assets_common"/>
            <div id="wrap" class="oe_structure oe_empty">
                <div class="container mt-4">
                    <div class="row justify-content-center">
                        <div class="col-md-6">
                            <div class="card border-danger">
                                <div class="card-header bg-danger text-white text-center">
                                    <h4 class="mb-0">
                                        <i class="fa fa-exclamation-triangle me-2"></i>
                                        Erreur
                                    </h4>
                                </div>
                                
                                <div class="card-body text-center">
                                    <div class="mb-4">
                                        <i class="fa fa-exclamation-circle text-danger" style="font-size: 4rem;"></i>
                                    </div>
                                    
                                    <p class="lead">
                                        <t t-esc="error_message"/>
                                    </p>
                                    
                                    <t t-if="service">
                                        <div class="alert alert-info">
                                            <strong>Service :</strong> <t t-esc="service.name"/>
                                        </div>
                                    </t>
                                </div>
                                
                                <div class="card-footer text-center">
                                    <a href="/queue" class="btn btn-primary">
                                        <i class="fa fa-home me-2"></i>
                                        Retour à l'accueil
                                    </a>
                                    <button onclick="history.back()" class="btn btn-secondary ms-2">
                                        <i class="fa fa-arrow-left me-2"></i>
                                        Retour
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </t>
    </template>
    
    <!-- Template ticket non trouvé -->
    <template id="ticket_not_found_template" name="Ticket Non Trouvé">
        <t t-call="website.layout">
            <!-- Appel des assets -->
            <t t-call="queue_management.queue_assets_common"/>
            <div id="wrap" class="oe_structure oe_empty">
                <div class="container mt-4">
                    <div class="row justify-content-center">
                        <div class="col-md-6">
                            <div class="card border-warning">
                                <div class="card-header bg-warning text-dark text-center">
                                    <h4 class="mb-0">
                                        <i class="fa fa-search me-2"></i>
                                        Ticket Non Trouvé
                                    </h4>
                                </div>
                                
                                <div class="card-body text-center">
                                    <div class="mb-4">
                                        <i class="fa fa-question-circle text-warning" style="font-size: 4rem;"></i>
                                    </div>
                                    
                                    <t t-if="reference">
                                        <p class="lead">
                                            Le ticket avec la référence <strong><t t-esc="reference"/></strong> n'a pas été trouvé.
                                        </p>
                                    </t>
                                    <t t-elif="ticket_number and service_id">
                                        <p class="lead">
                                            Le ticket <strong>#<t t-esc="ticket_number"/></strong> n'a pas été trouvé pour ce service.
                                        </p>
                                    </t>
                                    <t t-else="">
                                        <p class="lead">
                                            Le ticket demandé n'a pas été trouvé.
                                        </p>
                                    </t>
                                    
                                    <div class="alert alert-info">
                                        <h6>Vérifiez que :</h6>
                                        <ul class="list-unstyled mb-0">
                                            <li>• La référence est correcte</li>
                                            <li>• Le ticket n'a pas été supprimé</li>
                                            <li>• Vous utilisez la bonne référence</li>
                                        </ul>
                                    </div>
                                </div>
                                
                                <div class="card-footer text-center">
                                    <a href="/queue/search" class="btn btn-primary">
                                        <i class="fa fa-search me-2"></i>
                                        Nouvelle recherche
                                    </a>
                                    <a href="/queue" class="btn btn-secondary ms-2">
                                        <i class="fa fa-home me-2"></i>
                                        Accueil
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </t>
    </template>

    <!-- ========================================
         TEMPLATES D'ANNULATION
         ======================================== -->
    
    <!-- Template de formulaire d'annulation -->
    <!-- Template de formulaire d'annulation CORRIGÉ -->
    <template id="cancel_ticket_template" name="Annuler un Ticket">
        <t t-call="website.layout">
            <!-- Appel des assets -->
            <t t-call="queue_management.queue_assets_common"/>
            <div id="wrap" class="oe_structure oe_empty">
                <div class="container mt-4">
                    <div class="row justify-content-center">
                        <div class="col-md-6">
                            <div class="card border-warning">
                                <div class="card-header bg-warning text-dark text-center">
                                    <h4 class="mb-0">
                                        <i class="fa fa-times-circle me-2"></i>
                                        Annuler le Ticket
                                    </h4>
                                </div>
                                
                                <div class="card-body">
                                    <div class="alert alert-warning">
                                        <h5>Êtes-vous sûr de vouloir annuler votre ticket ?</h5>
                                        <hr/>
                                        <div class="row">
                                            <div class="col-6">
                                                <strong>Ticket :</strong> #<t t-esc="ticket.ticket_number"/>
                                            </div>
                                            <div class="col-6">
                                                <strong>Service :</strong> <t t-esc="ticket.service_id.name"/>
                                            </div>
                                        </div>
                                        <t t-if="reference">
                                            <div class="mt-2">
                                                <strong>Référence :</strong> <t t-esc="reference"/>
                                            </div>
                                        </t>
                                        <t t-if="ticket.ticket_reference">
                                            <div class="mt-2">
                                                <strong>Code de suivi :</strong> <t t-esc="ticket.ticket_reference"/>
                                            </div>
                                        </t>
                                    </div>
                                    
                                    <!-- FORMULAIRE CORRIGÉ avec action et token CSRF -->
                                    <form method="post" t-attf-action="/queue/cancel/#{reference or ticket.ticket_reference or (str(ticket.ticket_number) + '/' + str(ticket.service_id.id))}">
                                        <!-- Token CSRF pour la sécurité -->
                                        <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                                        
                                        <div class="mb-3">
                                            <label for="reason" class="form-label">
                                                Raison de l'annulation (optionnel)
                                            </label>
                                            <textarea class="form-control" 
                                                    id="reason" 
                                                    name="reason" 
                                                    rows="3"
                                                    placeholder="Pourquoi annulez-vous votre ticket ?"></textarea>
                                        </div>
                                        
                                        <!-- Hash de sécurité avec vérification de son existence -->
                                        <t t-if="security_hash">
                                            <input type="hidden" name="security_hash" t-att-value="security_hash"/>
                                        </t>
                                        <t t-elif="ticket.security_hash">
                                            <input type="hidden" name="security_hash" t-att-value="ticket.security_hash"/>
                                        </t>
                                        
                                        <!-- Champ caché pour identifier le ticket -->
                                        <input type="hidden" name="ticket_id" t-att-value="ticket.id"/>
                                        
                                        <div class="row mt-4">
                                            <div class="col-6">
                                                <!-- BOUTON RETOUR CORRIGÉ -->
                                                <t t-if="reference">
                                                    <a t-attf-href="/queue/track/#{reference}" class="btn btn-secondary w-100">
                                                        <i class="fa fa-arrow-left me-2"></i>
                                                        Retour
                                                    </a>
                                                </t>
                                                <t t-elif="ticket.ticket_reference">
                                                    <a t-attf-href="/queue/track/#{ticket.ticket_reference}" class="btn btn-secondary w-100">
                                                        <i class="fa fa-arrow-left me-2"></i>
                                                        Retour
                                                    </a>
                                                </t>
                                                <t t-else="">
                                                    <a t-attf-href="/queue/my_ticket/#{ticket.ticket_number}/#{ticket.service_id.id}" class="btn btn-secondary w-100">
                                                        <i class="fa fa-arrow-left me-2"></i>
                                                        Retour
                                                    </a>
                                                </t>
                                            </div>
                                            <div class="col-6">
                                                <button type="submit" class="btn btn-danger w-100"
                                                        onclick="return confirm('Êtes-vous vraiment sûr de vouloir annuler ce ticket ?');">
                                                    <i class="fa fa-times me-2"></i>
                                                    Confirmer l'annulation
                                                </button>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </t>
    </template>

    <!-- Template de succès d'annulation -->
    <template id="cancellation_success_template" name="Annulation Réussie">
        <t t-call="website.layout">
            <div id="wrap" class="oe_structure oe_empty">
                <div class="container mt-4">
                    <div class="row justify-content-center">
                        <div class="col-md-6">
                            <div class="card border-success">
                                <div class="card-header bg-success text-white text-center">
                                    <h4 class="mb-0">
                                        <i class="fa fa-check-circle me-2"></i>
                                        Annulation Confirmée
                                    </h4>
                                </div>
                                
                                <div class="card-body text-center">
                                    <div class="alert alert-success">
                                        <h5>✅ Votre ticket a été annulé avec succès</h5>
                                        <t t-if="message">
                                            <p class="mt-3"><t t-esc="message"/></p>
                                        </t>
                                        <t t-if="reference">
                                            <p><strong>Référence annulée :</strong> <t t-esc="reference"/></p>
                                        </t>
                                    </div>
                                    
                                    <div class="mt-4">
                                        <a href="/queue" class="btn btn-primary me-2">
                                            <i class="fa fa-home me-2"></i>
                                            Retour à l'accueil
                                        </a>
                                        <a href="/queue/search" class="btn btn-secondary">
                                            <i class="fa fa-search me-2"></i>
                                            Rechercher un ticket
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </t>
    </template>

    <!-- ========================================
         TEMPLATES D'ADMINISTRATION
         ======================================== -->
    
    <!-- Template de tableau de bord admin -->
    <template id="admin_dashboard_template" name="Administration - Tableau de Bord">
        <t t-call="website.layout">
            <!-- Appel des assets -->
            <t t-call="queue_management.queue_assets_common"/>
            <div id="wrap" class="oe_structure oe_empty">
                <div class="container-fluid mt-4">
                    <div class="row">
                        <div class="col-12">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h2>
                                    <i class="fa fa-dashboard me-2"></i>
                                    Tableau de Bord - Files d'Attente
                                </h2>
                                <div class="btn-group">
                                    <a href="/queue/admin/references" class="btn btn-outline-info">
                                        <i class="fa fa-link me-1"></i>Références
                                    </a>
                                    <a href="/queue" class="btn btn-outline-primary">
                                        <i class="fa fa-eye me-1"></i>Vue Public
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Statistiques globales -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="card bg-primary text-white">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h4 class="mb-0"><t t-esc="len(services)"/></h4>
                                            <p class="mb-0">Services Actifs</p>
                                        </div>
                                        <div>
                                            <i class="fa fa-users fa-2x opacity-75"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-3">
                            <div class="card bg-success text-white">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h4 class="mb-0"><t t-esc="total_tickets_today"/></h4>
                                            <p class="mb-0">Tickets Aujourd'hui</p>
                                        </div>
                                        <div>
                                            <i class="fa fa-ticket fa-2x opacity-75"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-3">
                            <div class="card bg-info text-white">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h4 class="mb-0"><t t-esc="tickets_with_references"/></h4>
                                            <p class="mb-0">Avec Références</p>
                                        </div>
                                        <div>
                                            <i class="fa fa-link fa-2x opacity-75"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-3">
                            <div class="card bg-warning text-dark">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h4 class="mb-0"><t t-esc="int(reference_coverage)"/>%</h4>
                                            <p class="mb-0">Couverture Réf.</p>
                                        </div>
                                        <div>
                                            <i class="fa fa-percent fa-2x opacity-75"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Services détaillés -->
                    <div class="row">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">
                                        <i class="fa fa-list me-2"></i>
                                        Services - État en Temps Réel
                                    </h5>
                                </div>
                                
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-hover">
                                            <thead class="table-dark">
                                                <tr>
                                                    <th>Service</th>
                                                    <th>État</th>
                                                    <th>En Attente</th>
                                                    <th>Ticket Actuel</th>
                                                    <th>Temps Moyen</th>
                                                    <th>Total Aujourd'hui</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <t t-foreach="services" t-as="service">
                                                    <tr>
                                                        <td>
                                                            <strong><t t-esc="service.name"/></strong>
                                                            <t t-if="service.description">
                                                                <br/><small class="text-muted"><t t-esc="service.description"/></small>
                                                            </t>
                                                        </td>
                                                        <td>
                                                            <t t-if="service.is_open">
                                                                <span class="badge bg-success">
                                                                    <i class="fa fa-circle me-1"></i>Ouvert
                                                                </span>
                                                            </t>
                                                            <t t-else="">
                                                                <span class="badge bg-danger">
                                                                    <i class="fa fa-circle me-1"></i>Fermé
                                                                </span>
                                                            </t>
                                                        </td>
                                                        <td>
                                                            <span class="badge bg-warning fs-6">
                                                                <t t-esc="service.waiting_count or 0"/>
                                                            </span>
                                                        </td>
                                                        <td>
                                                            <t t-if="service.current_ticket_number">
                                                                <strong>#<t t-esc="service.current_ticket_number"/></strong>
                                                            </t>
                                                            <t t-else="">
                                                                <span class="text-muted">Aucun</span>
                                                            </t>
                                                        </td>
                                                        <td>
                                                            <t t-esc="round(service.avg_waiting_time, 0) or 0"/> min
                                                        </td>
                                                        <td>
                                                            <t t-esc="service.total_tickets_today or 0"/>
                                                        </td>
                                                        <td>
                                                            <div class="btn-group btn-group-sm">
                                                                <button class="btn btn-outline-primary btn-sm" 
                                                                        onclick="callNextTicket(this)" 
                                                                        t-att-data-service-id="service.id">
                                                                    <i class="fa fa-bell"></i>
                                                                </button>
                                                                <button class="btn btn-outline-secondary btn-sm"
                                                                        onclick="viewServiceTickets(this)"
                                                                        t-att-data-service-id="service.id">
                                                                    <i class="fa fa-eye"></i>
                                                                </button>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                </t>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Actions rapides -->
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">
                                        <i class="fa fa-cogs me-2"></i>
                                        Actions Rapides
                                    </h5>
                                </div>
                                
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-3 mb-2">
                                            <button onclick="refreshStats()" class="btn btn-outline-primary w-100">
                                                <i class="fa fa-refresh me-2"></i>
                                                Actualiser Stats
                                            </button>
                                        </div>
                                        <div class="col-md-3 mb-2">
                                            <button onclick="generateReferences()" class="btn btn-outline-info w-100">
                                                <i class="fa fa-link me-2"></i>
                                                Générer Références
                                            </button>
                                        </div>
                                        <div class="col-md-3 mb-2">
                                            <button onclick="exportTickets()" class="btn btn-outline-success w-100">
                                                <i class="fa fa-download me-2"></i>
                                                Export CSV
                                            </button>
                                        </div>
                                        <div class="col-md-3 mb-2">
                                            <button onclick="maintenanceMode()" class="btn btn-outline-warning w-100">
                                                <i class="fa fa-wrench me-2"></i>
                                                Maintenance
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Scripts Admin -->
            <script>
                function callNextTicket(button) {
                    const serviceId = button.getAttribute('data-service-id');
                    // Appel AJAX pour appeler le prochain ticket
                    fetch('/queue/admin/call_next', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({service_id: serviceId})
                    }).then(response => response.json())
                      .then(data => {
                          if (data.success) {
                              location.reload();
                          } else {
                              alert('Erreur: ' + data.error);
                          }
                      });
                }
                
                function refreshStats() {
                    location.reload();
                }
                
                function generateReferences() {
                    if (confirm('Générer les références manquantes ?')) {
                        fetch('/queue/admin/generate_references', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                        }).then(response => response.json())
                          .then(data => {
                              alert(data.success ? data.message : 'Erreur: ' + data.error);
                              if (data.success) location.reload();
                          });
                    }
                }
                
                function exportTickets() {
                    window.open('/queue/export/tickets', '_blank');
                }
                
                function maintenanceMode() {
                    window.location.href = '/queue/admin/references';
                }
                
                // Auto-refresh toutes les 60 secondes
                setInterval(function() {
                    location.reload();
                }, 60000);
            </script>
        </t>
    </template>
    
    <!-- Template d'administration des références -->
    <template id="admin_references_template" name="Administration - Références">
        <t t-call="website.layout">
            <!-- Appel des assets -->
            <t t-call="queue_management.queue_assets_common"/>
            <div id="wrap" class="oe_structure oe_empty">
                <div class="container mt-4">
                    <div class="row">
                        <div class="col-12">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h2>
                                    <i class="fa fa-link me-2"></i>
                                    Gestion des Références
                                </h2>
                                <div class="btn-group">
                                    <a href="/queue/admin" class="btn btn-outline-primary">
                                        <i class="fa fa-arrow-left me-1"></i>Retour Admin
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Statistiques des références -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="card bg-primary text-white">
                                <div class="card-body text-center">
                                    <h3><t t-esc="stats.total_tickets"/></h3>
                                    <p class="mb-0">Total Tickets</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-3">
                            <div class="card bg-success text-white">
                                <div class="card-body text-center">
                                    <h3><t t-esc="stats.tickets_with_main_ref"/></h3>
                                    <p class="mb-0">Références Principales</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-3">
                            <div class="card bg-info text-white">
                                <div class="card-body text-center">
                                    <h3><t t-esc="stats.tickets_with_short_ref"/></h3>
                                    <p class="mb-0">Références Courtes</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-3">
                            <div class="card bg-warning text-dark">
                                <div class="card-body text-center">
                                    <h3><t t-esc="stats.tickets_with_hash"/></h3>
                                    <p class="mb-0">Hash Sécurité</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Vérification de l'unicité -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">
                                        <i class="fa fa-check-circle me-2"></i>
                                        Vérification de l'Unicité
                                    </h5>
                                </div>
                                
                                <div class="card-body">
                                    <t t-if="uniqueness_check.all_unique">
                                        <div class="alert alert-success">
                                            <i class="fa fa-check-circle me-2"></i>
                                            Toutes les références sont uniques!
                                        </div>
                                    </t>
                                    <t t-else="">
                                        <div class="alert alert-warning">
                                            <i class="fa fa-exclamation-triangle me-2"></i>
                                            Doublons détectés: <t t-esc="len(uniqueness_check.duplicates)"/> références dupliquées
                                        </div>
                                        
                                        <t t-if="uniqueness_check.duplicates">
                                            <h6>Références dupliquées :</h6>
                                            <ul>
                                                <t t-foreach="uniqueness_check.duplicates" t-as="dup">
                                                    <li><t t-esc="dup"/></li>
                                                </t>
                                            </ul>
                                        </t>
                                    </t>
                                    
                                    <button onclick="checkUniqueness()" class="btn btn-outline-primary">
                                        <i class="fa fa-refresh me-2"></i>
                                        Re-vérifier
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tickets récents -->
                    <div class="row">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">
                                        <i class="fa fa-clock me-2"></i>
                                        Tickets Récents (Aujourd'hui)
                                    </h5>
                                </div>
                                
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-sm table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Numéro</th>
                                                    <th>Référence</th>
                                                    <th>Code Court</th>
                                                    <th>Service</th>
                                                    <th>État</th>
                                                    <th>Créé</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <t t-foreach="recent_tickets" t-as="ticket">
                                                    <tr>
                                                        <td>
                                                            <strong>#<t t-esc="ticket.ticket_number"/></strong>
                                                        </td>
                                                        <td>
                                                            <t t-if="ticket.ticket_reference">
                                                                <code class="small"><t t-esc="ticket.ticket_reference"/></code>
                                                            </t>
                                                            <t t-else="">
                                                                <span class="text-muted">Non généré</span>
                                                            </t>
                                                        </td>
                                                        <td>
                                                            <t t-if="ticket.short_reference">
                                                                <strong><t t-esc="ticket.short_reference"/></strong>
                                                            </t>
                                                            <t t-else="">
                                                                <span class="text-muted">-</span>
                                                            </t>
                                                        </td>
                                                        <td><t t-esc="ticket.service_id.name"/></td>
                                                        <td>
                                                            <t t-if="ticket.state == 'waiting'">
                                                                <span class="badge bg-warning">Attente</span>
                                                            </t>
                                                            <t t-elif="ticket.state == 'called'">
                                                                <span class="badge bg-primary">Appelé</span>
                                                            </t>
                                                            <t t-elif="ticket.state == 'served'">
                                                                <span class="badge bg-success">Servi</span>
                                                            </t>
                                                            <t t-elif="ticket.state == 'cancelled'">
                                                                <span class="badge bg-danger">Annulé</span>
                                                            </t>
                                                        </td>
                                                        <td>
                                                            <small><t t-esc="ticket.created_time.strftime('%H:%M') if ticket.created_time else ''"/></small>
                                                        </td>
                                                        <td>
                                                            <t t-if="ticket.ticket_reference">
                                                                <a t-att-href="'/queue/track/' + ticket.ticket_reference" 
                                                                   class="btn btn-outline-primary btn-sm">
                                                                    <i class="fa fa-eye"></i>
                                                                </a>
                                                            </t>
                                                        </td>
                                                    </tr>
                                                </t>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Actions de maintenance -->
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">
                                        <i class="fa fa-wrench me-2"></i>
                                        Actions de Maintenance
                                    </h5>
                                </div>
                                
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-4 mb-3">
                                            <button onclick="generateMissingReferences()" 
                                                    class="btn btn-primary w-100">
                                                <i class="fa fa-plus me-2"></i>
                                                Générer Références Manquantes
                                            </button>
                                        </div>
                                        
                                        <div class="col-md-4 mb-3">
                                            <button onclick="cleanupOldTickets()" 
                                                    class="btn btn-warning w-100">
                                                <i class="fa fa-trash me-2"></i>
                                                Nettoyer Anciens Tickets
                                            </button>
                                        </div>
                                        
                                        <div class="col-md-4 mb-3">
                                            <button onclick="scheduledMaintenance()" 
                                                    class="btn btn-info w-100">
                                                <i class="fa fa-cogs me-2"></i>
                                                Maintenance Programmée
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Scripts de maintenance -->
            <script>
                function generateMissingReferences() {
                    if (confirm('Générer les références manquantes pour tous les tickets ?')) {
                        showLoader('Génération en cours...');
                        fetch('/queue/admin/generate_references', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'}
                        }).then(response => response.json())
                          .then(data => {
                              hideLoader();
                              alert(data.success ? data.message : 'Erreur: ' + data.error);
                              if (data.success) location.reload();
                          })
                          .catch(error => {
                              hideLoader();
                              alert('Erreur réseau: ' + error);
                          });
                    }
                }
                
                function cleanupOldTickets() {
                    if (confirm('Supprimer les tickets annulés de plus de 30 jours ?')) {
                        showLoader('Nettoyage en cours...');
                        fetch('/queue/maintenance', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({operation: 'cleanup_old_tickets'})
                        }).then(response => response.json())
                          .then(data => {
                              hideLoader();
                              alert(data.success ? data.message : 'Erreur: ' + data.error);
                              if (data.success) location.reload();
                          });
                    }
                }
                
                function scheduledMaintenance() {
                    if (confirm('Effectuer la maintenance programmée complète ?')) {
                        showLoader('Maintenance en cours...');
                        fetch('/queue/maintenance', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({operation: 'scheduled_maintenance'})
                        }).then(response => response.json())
                          .then(data => {
                              hideLoader();
                              alert(data.success ? 'Maintenance terminée!' : 'Erreur: ' + data.error);
                              if (data.success) location.reload();
                          });
                    }
                }
                
                function checkUniqueness() {
                    showLoader('Vérification...');
                    fetch('/queue/maintenance', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({operation: 'check_uniqueness'})
                    }).then(response => response.json())
                      .then(data => {
                          hideLoader();
                          if (data.success) {
                              location.reload();
                          } else {
                              alert('Erreur: ' + data.error);
                          }
                      });
                }
                
                function showLoader(message) {
                    // Affichage d'un loader simple
                    const loader = document.createElement('div');
                    loader.id = 'maintenance-loader';
                    loader.innerHTML = `
                        <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                                    background: rgba(0,0,0,0.7); z-index: 9999; display: flex; 
                                    align-items: center; justify-content: center; color: white;">
                            <div class="text-center">
                                <i class="fa fa-spinner fa-spin fa-3x mb-3"></i>
                                <p>${message}</p>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(loader);
                }
                
                function hideLoader() {
                    const loader = document.getElementById('maintenance-loader');
                    if (loader) loader.remove();
                }
            </script>
        </t>
    </template>

    <!-- ========================================
         TEMPLATES FEEDBACK
         ======================================== -->
    
    <!-- Template de formulaire de feedback corrigé -->
    <template id="feedback_form_template" name="Formulaire de Feedback">
        <t t-call="website.layout">
            <t t-call="queue_management.queue_assets_common"/>
            <div id="wrap" class="oe_structure oe_empty">
                <div class="container mt-4">
                    <div class="row justify-content-center">
                        <div class="col-md-6">
                            <!-- Message d'erreur si présent -->
                            <t t-if="error_message">
                                <div class="alert alert-danger" role="alert">
                                    <i class="fa fa-exclamation-triangle me-2"></i>
                                    <t t-esc="error_message"/>
                                </div>
                            </t>

                            <div class="card">
                                <div class="card-header bg-success text-white text-center">
                                    <h4 class="mb-0">
                                        <i class="fa fa-star me-2"></i>
                                        Votre Avis Compte!
                                    </h4>
                                </div>
                                
                                <div class="card-body">
                                    <div class="text-center mb-4">
                                        <h5>Comment s'est passé votre passage ?</h5>
                                        <div class="text-muted">
                                            Ticket <strong>#<t t-esc="ticket.ticket_number"/></strong>
                                            <t t-if="ticket.ticket_reference">
                                                - Réf: <strong><t t-esc="ticket.ticket_reference"/></strong>
                                            </t>
                                            <br/>
                                            Service: <strong><t t-esc="ticket.service_id.name"/></strong>
                                        </div>
                                    </div>
                                    
                                    <form method="post" id="feedbackForm">
                                        <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                                        
                                        <!-- Évaluation par étoiles -->
                                        <div class="mb-4 text-center">
                                            <label class="form-label fw-bold">Note globale *</label>
                                            <div class="rating-stars" style="font-size: 2rem; cursor: pointer;">
                                                <span class="star" data-rating="1" style="color: #dee2e6;">&#9734;</span>
                                                <span class="star" data-rating="2" style="color: #dee2e6;">&#9734;</span>
                                                <span class="star" data-rating="3" style="color: #dee2e6;">&#9734;</span>
                                                <span class="star" data-rating="4" style="color: #dee2e6;">&#9734;</span>
                                                <span class="star" data-rating="5" style="color: #dee2e6;">&#9734;</span>
                                            </div>
                                            <input type="hidden" name="rating" id="rating" required="required"/>
                                            <div class="invalid-feedback" id="ratingError" style="display: none;">
                                                Veuillez sélectionner une note
                                            </div>
                                        </div>
                                        
                                        <!-- Commentaire -->
                                        <div class="mb-3">
                                            <label for="feedback" class="form-label">
                                                Commentaire (optionnel)
                                            </label>
                                            <textarea class="form-control" 
                                                    id="feedback" 
                                                    name="feedback" 
                                                    rows="4"
                                                    maxlength="1000"
                                                    placeholder="Partagez votre expérience avec nous..."></textarea>
                                            <small class="form-text text-muted">
                                                Maximum 1000 caractères. <span id="charCount">0</span>/1000
                                            </small>
                                        </div>
                                        
                                        <div class="d-grid">
                                            <button type="submit" class="btn btn-success btn-lg" id="submitBtn">
                                                <i class="fa fa-paper-plane me-2"></i>
                                                <span id="submitText">Envoyer mon avis</span>
                                                <div class="spinner-border spinner-border-sm ms-2" id="submitSpinner" style="display: none;" role="status">
                                                    <span class="visually-hidden">Envoi...</span>
                                                </div>
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                            
                            <div class="text-center mt-3">
                                <a t-att-href="'/queue/track/' + reference if reference and '/' not in reference else '/queue'"
                                class="btn btn-link">
                                    <i class="fa fa-arrow-left me-1"></i>
                                    Retour
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Script pour les étoiles et validation -->
            <script>
                document.addEventListener('DOMContentLoaded', function() {
                    const stars = document.querySelectorAll('.star');
                    const ratingInput = document.getElementById('rating');
                    const feedbackTextarea = document.getElementById('feedback');
                    const charCount = document.getElementById('charCount');
                    const form = document.getElementById('feedbackForm');
                    const submitBtn = document.getElementById('submitBtn');
                    const submitText = document.getElementById('submitText');
                    const submitSpinner = document.getElementById('submitSpinner');
                    const ratingError = document.getElementById('ratingError');
                    
                    // Gestion des étoiles
                    stars.forEach((star, index) => {
                        star.addEventListener('click', function() {
                            const rating = parseInt(this.getAttribute('data-rating'));
                            ratingInput.value = rating;
                            
                            // Mise à jour visuelle
                            updateStarsDisplay(rating);
                            
                            // Cacher l'erreur si présente
                            ratingError.style.display = 'none';
                            ratingInput.classList.remove('is-invalid');
                        });
                        
                        star.addEventListener('mouseover', function() {
                            const rating = parseInt(this.getAttribute('data-rating'));
                            updateStarsDisplay(rating);
                        });
                    });
                    
                    // Restaurer l'affichage au survol
                    document.querySelector('.rating-stars').addEventListener('mouseleave', function() {
                        const currentRating = parseInt(ratingInput.value) || 0;
                        updateStarsDisplay(currentRating);
                    });
                    
                    // Fonction pour mettre à jour l'affichage des étoiles
                    function updateStarsDisplay(rating) {
                        stars.forEach((s, i) => {
                            if (i &lt; rating) {
                                s.innerHTML = '&#9733;'; // Étoile pleine
                                s.style.color = '#ffc107';
                            } else {
                                s.innerHTML = '&#9734;'; // Étoile vide
                                s.style.color = '#dee2e6';
                            }
                        });
                    }
                    
                    // Compteur de caractères
                    if (feedbackTextarea &amp;&amp; charCount) {
                        feedbackTextarea.addEventListener('input', function() {
                            const count = this.value.length;
                            charCount.textContent = count;
                            
                            if (count > 1000) {
                                charCount.style.color = '#dc3545';
                                this.value = this.value.substring(0, 1000);
                                charCount.textContent = '1000';
                            } else {
                                charCount.style.color = '#6c757d';
                            }
                        });
                    }
                    
                    // Validation du formulaire
                    form.addEventListener('submit', function(e) {
                        e.preventDefault();
                        
                        // Validation de la note
                        if (!ratingInput.value || parseInt(ratingInput.value) &lt; 1 || parseInt(ratingInput.value) > 5) {
                            ratingError.style.display = 'block';
                            ratingInput.classList.add('is-invalid');
                            document.querySelector('.rating-stars').scrollIntoView({ behavior: 'smooth', block: 'center' });
                            return;
                        }
                        
                        // Désactiver le bouton et afficher le spinner
                        submitBtn.disabled = true;
                        submitText.textContent = 'Envoi en cours...';
                        submitSpinner.style.display = 'inline-block';
                        
                        // Soumettre le formulaire
                        setTimeout(() => {
                            form.submit();
                        }, 500);
                    });
                    
                    // Animation d'entrée des étoiles
                    stars.forEach((star, index) => {
                        setTimeout(() => {
                            star.style.transform = 'scale(1.2)';
                            setTimeout(() => {
                                star.style.transform = 'scale(1)';
                            }, 150);
                        }, index * 100);
                    });
                });
            </script>
            
            <style>
                .rating-stars .star {
                    transition: all 0.2s ease;
                    margin: 0 2px;
                }
                
                .rating-stars .star:hover {
                    transform: scale(1.1);
                }
                
                .card {
                    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                    border: none;
                }
                
                .btn-success:disabled {
                    opacity: 0.7;
                }
                
                .invalid-feedback {
                    font-size: 0.9rem;
                    margin-top: 0.5rem;
                }
            </style>
        </t>
    </template>
    
    <!-- Template de remerciement corrigé -->
    <template id="feedback_thanks_template" name="Merci pour votre Feedback">
        <t t-call="website.layout">
            <t t-call="queue_management.queue_assets_common"/>
            <div id="wrap" class="oe_structure oe_empty">
                <div class="container mt-4">
                    <div class="row justify-content-center">
                        <div class="col-md-6">
                            <div class="card border-success">
                                <div class="card-header bg-success text-white text-center">
                                    <h4 class="mb-0">
                                        <i class="fa fa-heart me-2"></i>
                                        Merci pour votre avis!
                                    </h4>
                                </div>
                                
                                <div class="card-body text-center">
                                    <div class="mb-4">
                                        <i class="fa fa-thumbs-up text-success" style="font-size: 4rem;"></i>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <h5>Votre évaluation</h5>
                                        <div style="font-size: 1.5rem; color: #ffc107;">
                                            <t t-foreach="range(1, 6)" t-as="star">
                                                <span t-if="star &lt;= int(ticket.rating or 0)">&#9733;</span>
                                                <span t-if="star &gt; int(ticket.rating or 0)">&#9734;</span>
                                            </t>
                                        </div>
                                        <small class="text-muted">
                                            <t t-esc="ticket.rating or 0"/>/5 étoiles
                                        </small>
                                    </div>
                                    
                                    <p class="lead">
                                        Votre feedback a été enregistré avec succès.
                                    </p>
                                    
                                    <p class="text-muted">
                                        Nous utilisons vos commentaires pour améliorer continuellement 
                                        la qualité de nos services.
                                    </p>
                                    
                                    <div class="alert alert-light border" t-if="ticket.feedback">
                                        <small class="text-muted">Votre commentaire :</small>
                                        <div class="mt-1">
                                            <em>"<t t-esc="ticket.feedback"/>"</em>
                                        </div>
                                    </div>
                                    
                                    <div class="d-grid gap-2">
                                        <a href="/queue" class="btn btn-primary">
                                            <i class="fa fa-home me-2"></i>
                                            Retour à l'accueil
                                        </a>
                                        <a t-att-href="'/queue/track/' + reference if reference and '/' not in reference else '/queue/my_ticket/' + str(ticket.ticket_number) + '/' + str(ticket.service_id.id)" 
                                        class="btn btn-outline-secondary">
                                            <i class="fa fa-ticket me-2"></i>
                                            Voir mon ticket
                                        </a>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Encouragement pour futurs services -->
                            <div class="text-center mt-3">
                                <small class="text-muted">
                                    <i class="fa fa-info-circle me-1"></i>
                                    Merci de nous faire confiance pour vos démarches
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </t>
    </template>

    <!-- Template pour feedback déjà existant -->
    <template id="feedback_already_exists_template" name="Feedback Déjà Soumis">
        <t t-call="website.layout">
            <t t-call="queue_management.queue_assets_common"/>
            <div id="wrap" class="oe_structure oe_empty">
                <div class="container mt-4">
                    <div class="row justify-content-center">
                        <div class="col-md-6">
                            <div class="card border-warning">
                                <div class="card-header bg-warning text-dark text-center">
                                    <h4 class="mb-0">
                                        <i class="fa fa-info-circle me-2"></i>
                                        Feedback Déjà Soumis
                                    </h4>
                                </div>
                                
                                <div class="card-body text-center">
                                    <div class="mb-4">
                                        <i class="fa fa-check-circle text-success" style="font-size: 3rem;"></i>
                                    </div>
                                    
                                    <p class="lead">
                                        Vous avez déjà donné votre avis pour ce ticket.
                                    </p>
                                    
                                    <div class="alert alert-light">
                                        <div class="mb-2">
                                            <strong>Votre évaluation précédente :</strong>
                                        </div>
                                        <div style="font-size: 1.2rem; color: #ffc107;" class="mb-2">
                                            <t t-foreach="range(1, 6)" t-as="star">
                                                <span t-if="star &lt;= (existing_rating or 0)">&#9733;</span>
                                                <span t-if="star &gt; (existing_rating or 0)">&#9734;</span>
                                            </t>
                                        </div>
                                        <small class="text-muted">
                                            <t t-esc="existing_rating or 0"/>/5 étoiles
                                        </small>
                                        
                                        <div t-if="existing_feedback" class="mt-3">
                                            <small class="text-muted">Votre commentaire :</small>
                                            <div class="mt-1">
                                                <em>"<t t-esc="existing_feedback"/>"</em>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <p class="text-muted">
                                        Merci pour votre retour, il nous aide à améliorer nos services.
                                    </p>
                                    
                                    <div class="d-grid">
                                        <a href="/queue" class="btn btn-primary">
                                            <i class="fa fa-home me-2"></i>
                                            Retour à l'accueil
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </t>
    </template>

    <!-- Template d'administration des feedbacks -->
    <template id="admin_feedbacks_template" name="Administration des Feedbacks">
        <t t-call="website.layout">
            <t t-call="queue_management.queue_assets_common"/>
            <div id="wrap" class="oe_structure oe_empty">
                <div class="container-fluid mt-4">
                    <div class="row">
                        <div class="col-12">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h2>
                                    <i class="fa fa-star text-warning me-2"></i>
                                    Gestion des Feedbacks
                                </h2>
                                <div>
                                    <a href="/queue/export/feedbacks" class="btn btn-success">
                                        <i class="fa fa-download me-2"></i>
                                        Exporter CSV
                                    </a>
                                    <a href="/queue/admin" class="btn btn-secondary">
                                        <i class="fa fa-arrow-left me-2"></i>
                                        Retour Admin
                                    </a>
                                </div>
                            </div>
                            
                            <!-- Statistiques globales -->
                            <div class="row mb-4">
                                <div class="col-md-3">
                                    <div class="card bg-primary text-white">
                                        <div class="card-body text-center">
                                            <h3><t t-esc="stats.get('total_count', 0)"/></h3>
                                            <p class="mb-0">Total Feedbacks</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card bg-success text-white">
                                        <div class="card-body text-center">
                                            <h3><t t-esc="stats.get('avg_rating', 0)"/>/5</h3>
                                            <p class="mb-0">Note Moyenne</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card bg-info text-white">
                                        <div class="card-body text-center">
                                            <h3><t t-esc="stats.get('satisfaction_rate', 0)"/>%</h3>
                                            <p class="mb-0">Satisfaction (4-5★)</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card bg-warning text-white">
                                        <div class="card-body text-center">
                                            <h3><t t-esc="stats.get('rating_distribution', {}).get(5, 0)"/></h3>
                                            <p class="mb-0">Excellents (5★)</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Distribution des notes -->
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5>Distribution des Notes</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <t t-foreach="range(1, 6)" t-as="rating">
                                            <div class="col text-center">
                                                <div class="mb-2">
                                                    <span style="color: #ffc107; font-size: 1.2rem;">
                                                        <t t-foreach="range(rating)" t-as="star">&#9733;</t>
                                                    </span>
                                                </div>
                                                <h4><t t-esc="stats.get('rating_distribution', {}).get(rating, 0)"/></h4>
                                                <small class="text-muted"><t t-esc="rating"/> étoile<t t-if="rating > 1">s</t></small>
                                            </div>
                                        </t>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Filtres -->
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5>Filtres</h5>
                                </div>
                                <div class="card-body">
                                    <form method="get" class="row g-3">
                                        <div class="col-md-4">
                                            <label class="form-label">Service</label>
                                            <select name="service_id" class="form-select">
                                                <option value="">Tous les services</option>
                                                <t t-foreach="services" t-as="service">
                                                    <option t-att-value="service.id" 
                                                            t-att-selected="'selected' if service.id == current_service_id else None">
                                                        <t t-esc="service.name"/>
                                                    </option>
                                                </t>
                                            </select>
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">Note</label>
                                            <select name="rating" class="form-select">
                                                <option value="">Toutes les notes</option>
                                                <t t-foreach="range(1, 6)" t-as="r">
                                                    <option t-att-value="r" 
                                                            t-att-selected="'selected' if r == current_rating else None">
                                                        <t t-esc="r"/> étoile<t t-if="r > 1">s</t>
                                                    </option>
                                                </t>
                                            </select>
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">&#160;</label>
                                            <div>
                                                <button type="submit" class="btn btn-primary">
                                                    <i class="fa fa-filter me-2"></i>Filtrer
                                                </button>
                                                <a href="/queue/admin/feedbacks" class="btn btn-outline-secondary">
                                                    <i class="fa fa-times me-2"></i>Reset
                                                </a>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div>
                            
                            <!-- Liste des feedbacks -->
                            <div class="card">
                                <div class="card-header">
                                    <h5>Feedbacks Récents (<t t-esc="len(feedbacks)"/> résultats)</h5>
                                </div>
                                <div class="card-body">
                                    <t t-if="not feedbacks">
                                        <div class="text-center text-muted py-4">
                                            <i class="fa fa-inbox fa-3x mb-3"></i>
                                            <p>Aucun feedback trouvé avec ces critères.</p>
                                        </div>
                                    </t>
                                    
                                    <t t-if="feedbacks">
                                        <div class="table-responsive">
                                            <table class="table table-hover">
                                                <thead>
                                                    <tr>
                                                        <th>Ticket</th>
                                                        <th>Service</th>
                                                        <th>Client</th>
                                                        <th>Note</th>
                                                        <th>Commentaire</th>
                                                        <th>Date</th>
                                                        <th>Actions</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <t t-foreach="feedbacks" t-as="feedback">
                                                        <tr>
                                                            <td>
                                                                <strong>#<t t-esc="feedback.ticket_number"/></strong>
                                                                <br/>
                                                                <small class="text-muted">
                                                                    <t t-if="feedback.ticket_reference">
                                                                        <t t-esc="feedback.ticket_reference"/>
                                                                    </t>
                                                                </small>
                                                            </td>
                                                            <td>
                                                                <span class="badge bg-info">
                                                                    <t t-esc="feedback.service_id.name"/>
                                                                </span>
                                                            </td>
                                                            <td>
                                                                <t t-if="feedback.customer_name">
                                                                    <t t-esc="feedback.customer_name"/>
                                                                </t>
                                                                <t t-if="not feedback.customer_name">
                                                                    <em class="text-muted">Anonyme</em>
                                                                </t>
                                                            </td>
                                                            <td>
                                                                <div style="color: #ffc107;">
                                                                    <t t-foreach="range(1, 6)" t-as="star">
                                                                        <span t-if="star &lt;= (feedback.rating or 0)">&#9733;</span>
                                                                        <span t-if="star &gt; (feedback.rating or 0)">&#9734;</span>
                                                                    </t>
                                                                </div>
                                                                <small class="text-muted">
                                                                    <t t-esc="feedback.rating or 0"/>/5
                                                                </small>
                                                            </td>
                                                            <td>
                                                                <t t-if="feedback.feedback">
                                                                    <div class="feedback-text" style="max-width: 200px;">
                                                                        <t t-if="len(feedback.feedback) > 100">
                                                                            <span t-esc="feedback.feedback[:100]"/>...
                                                                            <a href="#" class="text-primary" onclick="showFullFeedback(this)">Voir plus</a>
                                                                            <div class="full-feedback" style="display: none;">
                                                                                <t t-esc="feedback.feedback"/>
                                                                                <a href="#" class="text-primary" onclick="hideFullFeedback(this)">Voir moins</a>
                                                                            </div>
                                                                        </t>
                                                                        <t t-if="len(feedback.feedback) &lt;= 100">
                                                                            <t t-esc="feedback.feedback"/>
                                                                        </t>
                                                                    </div>
                                                                </t>
                                                                <t t-if="not feedback.feedback">
                                                                    <em class="text-muted">Pas de commentaire</em>
                                                                </t>
                                                            </td>
                                                            <td>
                                                                <t t-if="feedback.feedback_time">
                                                                    <t t-esc="feedback.feedback_time.strftime('%d/%m/%Y %H:%M')"/>
                                                                </t>
                                                            </td>
                                                            <td>
                                                                <div class="btn-group btn-group-sm">
                                                                    <a t-att-href="'/queue/track/' + (feedback.ticket_reference or str(feedback.ticket_number) + '/' + str(feedback.service_id.id))" 
                                                                    class="btn btn-outline-primary" title="Voir le ticket">
                                                                        <i class="fa fa-eye"></i>
                                                                    </a>
                                                                    <button class="btn btn-outline-info" 
                                                                            onclick="copyFeedback(this)" 
                                                                            t-att-data-feedback="feedback.feedback or ''"
                                                                            title="Copier le commentaire">
                                                                        <i class="fa fa-copy"></i>
                                                                    </button>
                                                                </div>
                                                            </td>
                                                        </tr>
                                                    </t>
                                                </tbody>
                                            </table>
                                        </div>
                                    </t>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <script>
                function showFullFeedback(element) {
                    const parent = element.closest('.feedback-text');
                    const shortText = element.parentElement;
                    const fullText = parent.querySelector('.full-feedback');
                    
                    shortText.style.display = 'none';
                    fullText.style.display = 'block';
                }
                
                function hideFullFeedback(element) {
                    const parent = element.closest('.feedback-text');
                    const shortText = parent.querySelector('span').parentElement;
                    const fullText = element.parentElement;
                    
                    fullText.style.display = 'none';
                    shortText.style.display = 'block';
                }
                
                function copyFeedback(element) {
                    const feedback = element.getAttribute('data-feedback');
                    if (feedback) {
                        navigator.clipboard.writeText(feedback).then(() => {
                            // Feedback visuel
                            const icon = element.querySelector('i');
                            const originalClass = icon.className;
                            icon.className = 'fa fa-check text-success';
                            setTimeout(() => {
                                icon.className = originalClass;
                            }, 1000);
                        });
                    }
                }
            </script>
        </t>
    </template>

    <!-- Template de test du système de feedback -->
    <template id="test_feedback_template" name="Test du Système de Feedback">
        <t t-call="website.layout">
            <t t-call="queue_management.queue_assets_common"/>
            <div id="wrap" class="oe_structure oe_empty">
                <div class="container mt-4">
                    <div class="row">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header bg-info text-white">
                                    <h3 class="mb-0">
                                        <i class="fa fa-flask me-2"></i>
                                        Test du Système de Feedback
                                    </h3>
                                </div>
                                <div class="card-body">
                                    <t t-if="test_ticket">
                                        <div class="alert alert-success">
                                            <h4>✅ Ticket de test disponible</h4>
                                            <p><strong>Ticket #<t t-esc="test_ticket.ticket_number"/></strong> - <t t-esc="test_ticket.service_id.name"/></p>
                                            <p>État: <span class="badge bg-success">Servi</span></p>
                                            
                                            <t t-if="feedback_url">
                                                <a t-att-href="feedback_url" class="btn btn-primary" target="_blank">
                                                    <i class="fa fa-star me-2"></i>
                                                    Tester le Feedback
                                                </a>
                                            </t>
                                        </div>
                                        
                                        <t t-if="feedback_stats">
                                            <div class="card mt-3">
                                                <div class="card-header">
                                                    <h5>Statistiques Actuelles</h5>
                                                </div>
                                                <div class="card-body">
                                                    <div class="row text-center">
                                                        <div class="col-md-3">
                                                            <h4><t t-esc="feedback_stats.get('total_count', 0)"/></h4>
                                                            <small>Total Feedbacks</small>
                                                        </div>
                                                        <div class="col-md-3">
                                                            <h4><t t-esc="feedback_stats.get('avg_rating', 0)"/>/5</h4>
                                                            <small>Note Moyenne</small>
                                                        </div>
                                                        <div class="col-md-3">
                                                            <h4><t t-esc="feedback_stats.get('satisfaction_rate', 0)"/>%</h4>
                                                            <small>Satisfaction</small>
                                                        </div>
                                                        <div class="col-md-3">
                                                            <h4><t t-esc="feedback_stats.get('rating_distribution', {}).get(5, 0)"/></h4>
                                                            <small>Notes 5★</small>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </t>
                                    </t>
                                    
                                    <t t-if="not test_ticket">
                                        <div class="alert alert-warning">
                                            <h4>⚠️ Aucun ticket de test disponible</h4>
                                            <p>Aucun ticket servi trouvé pour tester le système de feedback.</p>
                                            <p>Créez d'abord des tickets et marquez-les comme servis.</p>
                                        </div>
                                    </t>
                                    
                                    <div class="mt-4">
                                        <h5>Fonctionnalités Testées</h5>
                                        <ul class="list-group">
                                            <li class="list-group-item">
                                                <i class="fa fa-check text-success me-2"></i>
                                                Formulaire de feedback avec étoiles interactives
                                            </li>
                                            <li class="list-group-item">
                                                <i class="fa fa-check text-success me-2"></i>
                                                Validation côté client et serveur
                                            </li>
                                            <li class="list-group-item">
                                                <i class="fa fa-check text-success me-2"></i>
                                                Prévention des feedbacks multiples
                                            </li>
                                            <li class="list-group-item">
                                                <i class="fa fa-check text-success me-2"></i>
                                                Page de remerciement personnalisée
                                            </li>
                                            <li class="list-group-item">
                                                <i class="fa fa-check text-success me-2"></i>
                                                Interface d'administration
                                            </li>
                                            <li class="list-group-item">
                                                <i class="fa fa-check text-success me-2"></i>
                                                Statistiques et export CSV
                                            </li>
                                        </ul>
                                    </div>
                                    
                                    <div class="mt-4">
                                        <a href="/queue/admin/feedbacks" class="btn btn-info">
                                            <i class="fa fa-chart-bar me-2"></i>
                                            Voir l'Administration
                                        </a>
                                        <a href="/queue" class="btn btn-secondary">
                                            <i class="fa fa-home me-2"></i>
                                            Retour Accueil
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </t>
    </template>

    <!-- ========================================
         TEMPLATES MOBILE
         ======================================== -->
    
    <!-- Template mobile optimisé -->
    <template id="mobile_ticket_template" name="Vue Mobile - Ticket">
        <t t-call="website.layout">
            <!-- Appel des assets -->
            <t t-call="queue_management.queue_assets_common"/>
            <div id="wrap" class="oe_structure oe_empty">
                <!-- Header mobile -->
                <div class="bg-primary text-white p-3 text-center">
                    <h4 class="mb-1">
                        <i class="fa fa-mobile me-2"></i>
                        Ticket Mobile
                    </h4>
                    <small>Gardez cette page ouverte</small>
                </div>
                
                <div class="container-fluid px-3">
                    <!-- Ticket principal -->
                    <div class="card mt-3 border-0 shadow">
                        <div class="card-body p-4 text-center">
                            <!-- Numéro de ticket -->
                            <div class="mb-3">
                                <div class="display-1 text-primary fw-bold mb-2">
                                    #<t t-esc="ticket.ticket_number"/>
                                </div>
                                
                                <t t-if="reference">
                                    <div class="badge bg-secondary fs-6 mb-2">
                                        <t t-esc="reference"/>
                                    </div>
                                </t>
                                
                                <h5 class="text-muted mb-0">
                                    <t t-esc="ticket.service_id.name"/>
                                </h5>
                            </div>
                            
                            <!-- État avec animation -->
                            <div class="mb-4">
                                <t t-if="ticket_data.state == 'waiting'">
                                    <div class="badge bg-warning fs-4 p-3 mb-2">
                                        <i class="fa fa-clock me-2"></i>En attente
                                    </div>
                                    <p class="text-muted">Votre tour arrive bientôt</p>
                                </t>
                                
                                <t t-elif="ticket_data.state == 'called'">
                                    <div class="badge bg-success fs-3 p-4 mb-2 animate__animated animate__pulse animate__infinite">
                                        <i class="fa fa-bell me-2"></i>
                                        C'EST VOTRE TOUR!
                                    </div>
                                    <p class="text-success fw-bold">Présentez-vous maintenant</p>
                                </t>
                                
                                <t t-elif="ticket_data.state == 'served'">
                                    <div class="badge bg-success fs-4 p-3 mb-2">
                                        <i class="fa fa-check me-2"></i>Terminé
                                    </div>
                                    <p class="text-muted">Service effectué</p>
                                </t>
                            </div>
                            
                            <!-- Informations en grand -->
                            <t t-if="ticket_data.state in ['waiting', 'called']">
                                <div class="row text-center mb-4">
                                    <div class="col-6">
                                        <div class="p-3 bg-light rounded">
                                            <div class="h1 text-warning mb-1">
                                                <t t-esc="ticket_data.position"/>
                                            </div>
                                            <small class="text-muted fw-bold">Position</small>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="p-3 bg-light rounded">
                                            <div class="h1 text-info mb-1">
                                                <t t-esc="ticket_data.estimated_wait_time or 0"/>
                                            </div>
                                            <small class="text-muted fw-bold">Min restantes</small>
                                        </div>
                                    </div>
                                </div>
                            </t>
                        </div>
                    </div>
                    
                    <!-- Actions mobiles -->
                    <div class="row mt-3 mb-4">
                        <div class="col-6">
                            <button onclick="location.reload()" 
                                    class="btn btn-primary w-100 btn-lg">
                                <i class="fa fa-refresh"></i>
                                <br/><small>Actualiser</small>
                            </button>
                        </div>
                        <div class="col-6">
                            <t t-if="ticket_data.can_cancel">
                                <a t-att-href="'/queue/cancel/' + reference"
                                   class="btn btn-outline-danger w-100 btn-lg">
                                    <i class="fa fa-times"></i>
                                    <br/><small>Annuler</small>
                                </a>
                            </t>
                            <t t-else="">
                                <button class="btn btn-outline-secondary w-100 btn-lg disabled">
                                    <i class="fa fa-info-circle"></i>
                                    <br/><small>Info</small>
                                </button>
                            </t>
                        </div>
                    </div>
                    
                    <!-- Informations complémentaires -->
                    <div class="card mt-3">
                        <div class="card-body">
                            <h6 class="card-title">
                                <i class="fa fa-info-circle me-2"></i>
                                Informations
                            </h6>
                            
                            <div class="row small">
                                <div class="col-6">
                                    <strong>Créé:</strong><br/>
                                    <t t-esc="ticket.created_time.strftime('%H:%M') if ticket.created_time else ''"/>
                                </div>
                                <div class="col-6">
                                    <strong>Service:</strong><br/>
                                    <t t-esc="ticket.service_id.name"/>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Auto-refresh agressif pour mobile -->
            <script>
                // Refresh plus fréquent pour mobile
                setInterval(function() {
                    if (document.visibilityState === 'visible') {
                        location.reload();
                    }
                }, 15000); // Toutes les 15 secondes
                
                // Vibration pour les notifications (si supporté)
                if ('vibrate' in navigator) {
                    <t t-if="ticket_data.state == 'called'">
                        navigator.vibrate([200, 100, 200]);
                    </t>
                }
            </script>
        </t>
    </template>
    
    <!-- Template d'erreur mobile -->
    <template id="mobile_error_template" name="Erreur Mobile">
        <t t-call="website.layout">
            <!-- Appel des assets -->
            <t t-call="queue_management.queue_assets_common"/>
            <div id="wrap" class="oe_structure oe_empty">
                <div class="bg-danger text-white p-3 text-center">
                    <h4 class="mb-0">
                        <i class="fa fa-exclamation-triangle me-2"></i>
                        Erreur
                    </h4>
                </div>
                
                <div class="container-fluid px-3">
                    <div class="card mt-3">
                        <div class="card-body text-center">
                            <i class="fa fa-exclamation-circle text-danger mb-3" style="font-size: 3rem;"></i>
                            <p class="lead"><t t-esc="error_message"/></p>
                            
                            <div class="d-grid gap-2">
                                <a href="/queue" class="btn btn-primary">Accueil</a>
                                <button onclick="history.back()" class="btn btn-secondary">Retour</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </t>
    </template>

    <!-- ========================================
         TEMPLATES UTILITAIRES
         ======================================== -->
    
    <!-- Fragment pour affichage d'un service -->
    <template id="service_card_fragment" name="Fragment - Carte Service">
        <div class="card h-100 shadow-sm service-card" t-att-data-service-id="service.id">
            <div class="card-header" t-attf-class="bg-{{ 'success' if service.is_open else 'secondary' }} text-white">
                <h5 class="card-title mb-0">
                    <i class="fa fa-users me-2"></i>
                    <t t-esc="service.name"/>
                </h5>
            </div>
            
            <div class="card-body">
                <div class="row text-center mb-3">
                    <div class="col-4">
                        <div class="h4 text-warning mb-0" id="waiting-count">
                            <t t-esc="service.waiting_count or 0"/>
                        </div>
                        <small class="text-muted">Attente</small>
                    </div>
                    <div class="col-4">
                        <div class="h4 text-info mb-0">
                            <t t-esc="round(service.avg_waiting_time, 0) or 0"/>min
                        </div>
                        <small class="text-muted">Temps</small>
                    </div>
                    <div class="col-4">
                        <div class="h4 text-success mb-0">
                            <t t-esc="service.current_ticket_number or 0"/>
                        </div>
                        <small class="text-muted">Actuel</small>
                    </div>
                </div>
                
                <t t-if="service.description">
                    <p class="card-text text-muted small mb-3">
                        <t t-esc="service.description"/>
                    </p>
                </t>
                
                <div class="d-grid">
                    <t t-if="service.is_open">
                        <button onclick="takeTicket(this)" 
                                t-att-data-service-id="service.id"
                                class="btn btn-success btn-lg take-ticket-btn">
                            <i class="fa fa-ticket me-2"></i>
                            Prendre un ticket
                        </button>
                    </t>
                    <t t-else="">
                        <button class="btn btn-secondary btn-lg disabled">
                            <i class="fa fa-clock me-2"></i>
                            Service fermé
                        </button>
                    </t>
                </div>
            </div>
        </div>
    </template>
    
    <!-- Fragment pour statut de ticket -->
    <template id="ticket_status_fragment" name="Fragment - Statut Ticket">
        <div class="ticket-status" t-att-data-ticket-state="ticket.state">
            <t t-if="ticket.state == 'waiting'">
                <span class="badge bg-warning fs-6">
                    <i class="fa fa-clock me-1"></i>En attente - Position <t t-esc="position"/>
                </span>
            </t>
            <t t-elif="ticket.state == 'called'">
                <span class="badge bg-success fs-6 animate__animated animate__pulse animate__infinite">
                    <i class="fa fa-bell me-1"></i>Appelé - Présentez-vous!
                </span>
            </t>
            <t t-elif="ticket.state == 'served'">
                <span class="badge bg-success fs-6">
                    <i class="fa fa-check me-1"></i>Service terminé
                </span>
            </t>
            <t t-elif="ticket.state == 'cancelled'">
                <span class="badge bg-danger fs-6">
                    <i class="fa fa-times me-1"></i>Ticket annulé
                </span>
            </t>
            <t t-else="">
                <span class="badge bg-secondary fs-6">
                    <t t-esc="ticket.state"/>
                </span>
            </t>
        </div>
    </template>

    <!-- ========================================
         TEMPLATES D'EMAIL (pour notifications)
         ======================================== -->
    
    <!-- Email de confirmation de ticket -->
    <template id="ticket_confirmation_email" name="Email - Confirmation Ticket">
        <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
            <div style="background-color: #007bff; color: white; padding: 20px; text-align: center;">
                <h2>Votre ticket a été créé!</h2>
                <p>Merci d'avoir pris un ticket pour nos services</p>
            </div>
            
            <div style="padding: 20px;">
                <div style="text-align: center; margin-bottom: 30px;">
                    <h1 style="color: #007bff; font-size: 3em; margin: 10px 0;">
                        #<t t-esc="ticket.ticket_number"/>
                    </h1>
                    
                    <t t-if="ticket.ticket_reference">
                        <div style="background: #f8f9fa; padding: 10px; border-radius: 5px; margin: 10px 0;">
                            <strong>Référence:</strong> <t t-esc="ticket.ticket_reference"/>
                        </div>
                    </t>
                    
                    <h3 style="color: #6c757d; margin: 10px 0;">
                        <t t-esc="ticket.service_id.name"/>
                    </h3>
                </div>
                
                <table style="width: 100%; border-collapse: collapse; margin: 20px 0;">
                    <tr>
                        <td style="padding: 10px; text-align: center; border: 1px solid #dee2e6;">
                            <strong style="color: #ffc107; font-size: 1.5em;"><t t-esc="position"/></strong><br/>
                            <small>Position</small>
                        </td>
                        <td style="padding: 10px; text-align: center; border: 1px solid #dee2e6;">
                            <strong style="color: #17a2b8; font-size: 1.5em;"><t t-esc="estimated_wait"/>min</strong><br/>
                            <small>Temps estimé</small>
                        </td>
                        <td style="padding: 10px; text-align: center; border: 1px solid #dee2e6;">
                            <t t-if="ticket.state == 'waiting'"><strong style="color: #28a745; font-size: 1.5em;">En attente</strong></t>
                            <t t-if="ticket.state == 'called'"><strong style="color: #28a745; font-size: 1.5em;">Appelé</strong></t>
                            <t t-if="ticket.state == 'serving'"><strong style="color: #28a745; font-size: 1.5em;">En Service</strong></t>
                            <t t-if="ticket.state == 'served'"><strong style="color: #28a745; font-size: 1.5em;">Servi</strong></t>
                            <t t-if="ticket.state == 'cancelled'"><strong style="color: #28a745; font-size: 1.5em;">Annulé</strong></t>
                            <t t-if="ticket.state == 'no_show'"><strong style="color: #dc3545; font-size: 1.5em;">Absent</strong></t>
                            <small>État</small>
                        </td>
                    </tr>
                </table>
                
                <div style="text-align: center; margin: 30px 0;">
                    <a t-att-href="base_url + track_url"
                       style="background-color: #007bff; color: white; padding: 15px 30px; 
                              text-decoration: none; border-radius: 5px; display: inline-block;">
                        Suivre mon ticket
                    </a>
                </div>
                
                <div style="background: #f8f9fa; padding: 20px; border-radius: 5px; margin: 20px 0;">
                    <h4>Instructions importantes:</h4>
                    <ul>
                        <li>Gardez ce numéro de ticket: <strong>#<t t-esc="ticket.ticket_number"/></strong></li>
                        <li>Suivez votre position en temps réel via le lien ci-dessus</li>
                        <li>Présentez-vous quand votre numéro sera appelé</li>
                        <li>En cas d'annulation, utilisez la référence: <t t-esc="ticket.ticket_reference or 'Non générée'"/></li>
                    </ul>
                </div>
            </div>
            
            <div style="background-color: #f8f9fa; padding: 20px; text-align: center; color: #6c757d;">
                <small>
                    Ticket créé le <t t-esc="ticket.created_time.strftime('%d/%m/%Y à %H:%M') if ticket.created_time else ''"/><br/>
                    Cet email est automatique, merci de ne pas y répondre.
                </small>
            </div>
        </div>
    </template>
    
    <!-- Email de notification d'appel -->
    <template id="ticket_called_email" name="Email - Ticket Appelé">
        <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
            <div style="background-color: #28a745; color: white; padding: 20px; text-align: center;">
                <h2>🔔 Votre ticket est appelé!</h2>
                <p>Il est temps de vous présenter</p>
            </div>
            
            <div style="padding: 20px; text-align: center;">
                <div style="background: #d4edda; border: 2px solid #28a745; 
                           border-radius: 10px; padding: 30px; margin: 20px 0;">
                    <h1 style="color: #28a745; font-size: 4em; margin: 0;">
                        #<t t-esc="ticket.ticket_number"/>
                    </h1>
                    <h2 style="color: #155724; margin: 10px 0;">
                        C'EST VOTRE TOUR!
                    </h2>
                </div>
                
                <p style="font-size: 1.2em; color: #155724; font-weight: bold;">
                    Présentez-vous immédiatement à l'accueil du service 
                    <strong><t t-esc="ticket.service_id.name"/></strong>
                </p>
                
                <div style="margin: 30px 0;">
                    <a t-att-href="base_url + track_url"
                       style="background-color: #28a745; color: white; padding: 15px 30px; 
                              text-decoration: none; border-radius: 5px; display: inline-block; font-size: 1.1em;">
                        Voir les détails
                    </a>
                </div>
            </div>
            
            <div style="background-color: #f8f9fa; padding: 15px; text-align: center; color: #6c757d;">
                <small>
                    Notification envoyée le <t t-esc="datetime.now().strftime('%d/%m/%Y à %H:%M')"/><br/>
                    Référence: <t t-esc="ticket.ticket_reference or ticket.id"/>
                </small>
            </div>
        </div>
    </template>

    <!-- ========================================
         TEMPLATES DE REPORTING/STATS
         ======================================== -->
    
    <!-- Template de rapport quotidien -->
    <template id="daily_report_template" name="Rapport Quotidien">
        <t t-call="website.layout">
            <!-- Appel des assets -->
            <t t-call="queue_management.queue_assets_common"/>
            <div id="wrap" class="oe_structure oe_empty">
                <div class="container mt-4">
                    <div class="row">
                        <div class="col-12">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h2>
                                    <i class="fa fa-chart-bar me-2"></i>
                                    Rapport Quotidien - <t t-esc="report_date"/>
                                </h2>
                                <div class="btn-group">
                                    <button onclick="window.print()" class="btn btn-outline-primary">
                                        <i class="fa fa-print me-1"></i>Imprimer
                                    </button>
                                    <button onclick="exportReport()" class="btn btn-outline-success">
                                        <i class="fa fa-download me-1"></i>Exporter
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Résumé global -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="card text-center">
                                <div class="card-body">
                                    <h3 class="text-primary"><t t-esc="stats.total_tickets"/></h3>
                                    <p class="mb-0">Total Tickets</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-center">
                                <div class="card-body">
                                    <h3 class="text-success"><t t-esc="stats.served_tickets"/></h3>
                                    <p class="mb-0">Tickets Servis</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-center">
                                <div class="card-body">
                                    <h3 class="text-warning"><t t-esc="stats.waiting_tickets"/></h3>
                                    <p class="mb-0">En Attente</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-center">
                                <div class="card-body">
                                    <h3 class="text-info"><t t-esc="stats.avg_wait_time"/>min</h3>
                                    <p class="mb-0">Temps Moyen</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Performance par service -->
                    <div class="row">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">Performance par Service</h5>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-striped">
                                            <thead>
                                                <tr>
                                                    <th>Service</th>
                                                    <th>Tickets Total</th>
                                                    <th>Tickets Servis</th>
                                                    <th>Taux Service</th>
                                                    <th>Temps Moyen</th>
                                                    <th>Satisfaction</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <t t-foreach="service_stats" t-as="stat">
                                                    <tr>
                                                        <td><strong><t t-esc="stat.service_name"/></strong></td>
                                                        <td><t t-esc="stat.total_tickets"/></td>
                                                        <td><t t-esc="stat.served_tickets"/></td>
                                                        <td>
                                                            <div class="progress" style="height: 20px;">
                                                                <div class="progress-bar bg-success" 
                                                                     t-att-style="'width: ' + str(stat.service_rate) + '%'">
                                                                    <t t-esc="stat.service_rate"/>%
                                                                </div>
                                                            </div>
                                                        </td>
                                                        <td><t t-esc="stat.avg_wait_time"/>min</td>
                                                        <td>
                                                            <t t-if="stat.avg_rating">
                                                                <span class="badge bg-success">
                                                                    <t t-esc="stat.avg_rating"/>/5 ⭐
                                                                </span>
                                                            </t>
                                                            <t t-else="">
                                                                <span class="text-muted">N/A</span>
                                                            </t>
                                                        </td>
                                                    </tr>
                                                </t>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </t>
    </template>

    <!-- ========================================
         TEMPLATES DE PRINT/IMPRESSION
         ======================================== -->
    
    <!-- Template d'impression de ticket (version web) -->
    <template id="print_ticket_template" name="Impression Ticket">
        <t t-call="web.html_container">
            <t t-call="queue_management.queue_assets_common"/>
            <div class="page" style="font-family: 'Courier New', monospace;">
                <style>
                    @media print {
                        @page { 
                            margin: 5mm;
                            size: 80mm auto;
                        }
                        body { 
                            margin: 0; 
                            font-size: 12px;
                            line-height: 1.2;
                        }
                        .no-print { display: none !important; }
                    }
                    
                    .ticket-container {
                        width: 58mm;
                        margin: 0 auto;
                        text-align: center;
                        padding: 5mm;
                        border: 2px dashed #000;
                    }
                    
                    .ticket-header {
                        border-bottom: 2px dashed #000;
                        padding-bottom: 5px;
                        margin-bottom: 10px;
                    }
                    
                    .ticket-number {
                        font-size: 24px;
                        font-weight: bold;
                        margin: 10px 0;
                    }
                    
                    .reference-code {
                        font-size: 14px;
                        font-weight: bold;
                        margin: 5px 0;
                        background: #f0f0f0;
                        padding: 3px;
                    }
                    
                    .service-name {
                        font-size: 16px;
                        font-weight: bold;
                        margin: 8px 0;
                    }
                    
                    .ticket-info {
                        margin: 5px 0;
                        font-size: 11px;
                    }
                    
                    .ticket-footer {
                        border-top: 2px dashed #000;
                        padding-top: 8px;
                        margin-top: 10px;
                        font-size: 10px;
                    }
                    
                    .qr-code {
                        margin: 8px 0;
                    }
                </style>
                
                <div class="ticket-container">
                    <!-- En-tête -->
                    <div class="ticket-header">
                        <div class="service-name"><t t-esc="service.name"/></div>
                        <div class="ticket-number">#<t t-esc="ticket.ticket_number"/></div>
                        
                        <t t-if="ticket.ticket_reference">
                            <div class="reference-code">
                                <t t-esc="ticket.ticket_reference"/>
                            </div>
                        </t>
                        
                        <t t-if="ticket.short_reference">
                            <div style="font-size: 12px; margin: 3px 0;">
                                Code: <strong><t t-esc="ticket.short_reference"/></strong>
                            </div>
                        </t>
                    </div>
                    
                    <!-- Informations principales -->
                    <div class="ticket-info">
                        <div><strong>Position:</strong> <t t-esc="position"/></div>
                        <div><strong>Temps estimé:</strong> ~<t t-esc="ticket.estimated_wait_time or (position * 5)"/> min</div>
                        <div><strong>État:</strong> En attente</div>
                    </div>
                    
                    <div class="ticket-info" style="margin-top: 8px;">
                        <div><strong>Date:</strong> <t t-esc="datetime.now().strftime('%d/%m/%Y %H:%M')"/></div>
                        <t t-if="ticket.customer_name">
                            <div><strong>Client:</strong> <t t-esc="ticket.customer_name"/></div>
                        </t>
                    </div>
                    
                    <!-- QR Code -->
                    <div class="qr-code">
                        <img t-att-src="'https://api.qrserver.com/v1/create-qr-code/?size=100x100&amp;data=' + track_url"
                             alt="QR Code" style="width: 50px; height: 50px;"/>
                    </div>
                    
                    <!-- Pied de page -->
                    <div class="ticket-footer">
                        <div>Présentez-vous quand</div>
                        <div>votre numéro sera appelé</div>
                        <div style="margin-top: 5px;">
                            Suivi: <t t-esc="request.httprequest.host.split(':')[0]"/>
                        </div>
                        <t t-if="ticket.short_reference">
                            <div style="margin-top: 3px; font-size: 9px;">
                                Réf: <t t-esc="ticket.short_reference"/>
                            </div>
                        </t>
                    </div>
                </div>
                
                <!-- Boutons d'action (masqués à l'impression) -->
                <div class="text-center mt-3 no-print">
                    <button onclick="window.print()" class="btn btn-primary me-2">
                        <i class="fa fa-print me-1"></i>Imprimer
                    </button>
                    <button onclick="window.close()" class="btn btn-secondary">
                        <i class="fa fa-times me-1"></i>Fermer
                    </button>
                </div>
            </div>
        </t>
    </template>
    
    <!-- Template d'impression de rapport -->
    <template id="print_report_template" name="Impression Rapport">
        <t t-call="web.html_container">
            <div class="page">
                <style>
                    @media print {
                        @page { margin: 15mm; }
                        .no-print { display: none !important; }
                    }
                    
                    .report-header {
                        border-bottom: 3px solid #007bff;
                        padding-bottom: 15px;
                        margin-bottom: 20px;
                    }
                    
                    .stats-grid {
                        display: grid;
                        grid-template-columns: repeat(4, 1fr);
                        gap: 15px;
                        margin-bottom: 25px;
                    }
                    
                    .stat-card {
                        border: 1px solid #dee2e6;
                        border-radius: 5px;
                        padding: 15px;
                        text-align: center;
                    }
                    
                    .stat-number {
                        font-size: 2em;
                        font-weight: bold;
                        color: #007bff;
                    }
                    
                    .report-table {
                        width: 100%;
                        border-collapse: collapse;
                        margin-bottom: 20px;
                    }
                    
                    .report-table th,
                    .report-table td {
                        border: 1px solid #dee2e6;
                        padding: 8px;
                        text-align: left;
                    }
                    
                    .report-table th {
                        background-color: #f8f9fa;
                        font-weight: bold;
                    }
                </style>
                
                <div class="report-header">
                    <h1>Rapport des Files d'Attente</h1>
                    <div class="row">
                        <div class="col-6">
                            <strong>Période:</strong> <t t-esc="report_period"/>
                        </div>
                        <div class="col-6 text-end">
                            <strong>Généré le:</strong> <t t-esc="datetime.now().strftime('%d/%m/%Y à %H:%M')"/>
                        </div>
                    </div>
                </div>
                
                <!-- Statistiques globales -->
                <h3>Résumé Global</h3>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number"><t t-esc="global_stats.total_tickets"/></div>
                        <div>Total Tickets</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number"><t t-esc="global_stats.served_tickets"/></div>
                        <div>Tickets Servis</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number"><t t-esc="global_stats.avg_wait_time"/>min</div>
                        <div>Temps Moyen</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number"><t t-esc="global_stats.satisfaction_rate"/>%</div>
                        <div>Satisfaction</div>
                    </div>
                </div>
                
                <!-- Détail par service -->
                <h3>Performance par Service</h3>
                <table class="report-table">
                    <thead>
                        <tr>
                            <th>Service</th>
                            <th>Total</th>
                            <th>Servis</th>
                            <th>Taux (%)</th>
                            <th>Temps Moy.</th>
                            <th>Satisfaction</th>
                        </tr>
                    </thead>
                    <tbody>
                        <t t-foreach="service_details" t-as="service">
                            <tr>
                                <td><strong><t t-esc="service.name"/></strong></td>
                                <td><t t-esc="service.total_tickets"/></td>
                                <td><t t-esc="service.served_tickets"/></td>
                                <td><t t-esc="service.service_rate"/>%</td>
                                <td><t t-esc="service.avg_wait_time"/>min</td>
                                <td><t t-esc="service.avg_rating or 'N/A'"/></td>
                            </tr>
                        </t>
                    </tbody>
                </table>
                
                <!-- Commentaires -->
                <t t-if="feedback_comments">
                    <h3>Commentaires Clients</h3>
                    <div style="border: 1px solid #dee2e6; padding: 15px; border-radius: 5px;">
                        <t t-foreach="feedback_comments[:10]" t-as="comment">
                            <div style="margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid #eee;">
                                <div><strong>Service:</strong> <t t-esc="comment.service_name"/> | 
                                     <strong>Note:</strong> <t t-esc="comment.rating"/>/5</div>
                                <div style="font-style: italic; color: #666;">
                                    "<t t-esc="comment.feedback"/>"
                                </div>
                                <small class="text-muted">
                                    <t t-esc="comment.date.strftime('%d/%m/%Y')"/>
                                </small>
                            </div>
                        </t>
                    </div>
                </t>
                
                <!-- Pied de page -->
                <div style="margin-top: 30px; padding-top: 15px; border-top: 1px solid #dee2e6; 
                           text-align: center; color: #666; font-size: 12px;">
                    <p>Rapport généré automatiquement par le système de gestion des files d'attente</p>
                    <p>Page <span class="page-number"></span></p>
                </div>
            </div>
        </t>
    </template>

    <!-- ========================================
         TEMPLATES DE CONFIGURATION/SETTINGS
         ======================================== -->
    
    <!-- Template de configuration système -->
    <template id="system_settings_template" name="Configuration Système">
        <t t-call="website.layout">
            <!-- Appel des assets -->
            <t t-call="queue_management.queue_assets_common"/>
            <div id="wrap" class="oe_structure oe_empty">
                <div class="container mt-4">
                    <div class="row">
                        <div class="col-12">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h2>
                                    <i class="fa fa-cogs me-2"></i>
                                    Configuration du Système
                                </h2>
                                <a href="/queue/admin" class="btn btn-outline-primary">
                                    <i class="fa fa-arrow-left me-1"></i>Retour Admin
                                </a>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Onglets de configuration -->
                    <ul class="nav nav-tabs" id="settingsTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="general-tab" data-bs-toggle="tab" 
                                    data-bs-target="#general" type="button" role="tab">
                                <i class="fa fa-gear me-1"></i>Général
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="notifications-tab" data-bs-toggle="tab" 
                                    data-bs-target="#notifications" type="button" role="tab">
                                <i class="fa fa-bell me-1"></i>Notifications
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="references-tab" data-bs-toggle="tab" 
                                    data-bs-target="#references" type="button" role="tab">
                                <i class="fa fa-link me-1"></i>Références
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="maintenance-tab" data-bs-toggle="tab" 
                                    data-bs-target="#maintenance" type="button" role="tab">
                                <i class="fa fa-wrench me-1"></i>Maintenance
                            </button>
                        </li>
                    </ul>
                    
                    <div class="tab-content" id="settingsTabsContent">
                        <!-- Onglet Général -->
                        <div class="tab-pane fade show active" id="general" role="tabpanel">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title">Paramètres Généraux</h5>
                                    
                                    <form id="generalSettingsForm">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label class="form-label">Temps d'attente par défaut (minutes)</label>
                                                    <input type="number" class="form-control" 
                                                           name="default_wait_time" value="5" min="1" max="60"/>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label class="form-label">Auto-refresh interval (secondes)</label>
                                                    <input type="number" class="form-control" 
                                                           name="refresh_interval" value="30" min="10" max="300"/>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="form-check mb-3">
                                                    <input class="form-check-input" type="checkbox" 
                                                           name="enable_sms" id="enableSMS"/>
                                                    <label class="form-check-label" for="enableSMS">
                                                        Activer les notifications SMS
                                                    </label>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="form-check mb-3">
                                                    <input class="form-check-input" type="checkbox" 
                                                           name="enable_email" id="enableEmail"/>
                                                    <label class="form-check-label" for="enableEmail">
                                                        Activer les notifications Email
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fa fa-save me-2"></i>Sauvegarder
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Onglet Notifications -->
                        <div class="tab-pane fade" id="notifications" role="tabpanel">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title">Configuration des Notifications</h5>
                                    
                                    <form id="notificationSettingsForm">
                                        <div class="mb-4">
                                            <h6>Notifications par Email</h6>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" 
                                                       name="email_on_ticket_created" id="emailCreated"/>
                                                <label class="form-check-label" for="emailCreated">
                                                    Confirmation de création de ticket
                                                </label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" 
                                                       name="email_on_ticket_called" id="emailCalled"/>
                                                <label class="form-check-label" for="emailCalled">
                                                    Notification quand le ticket est appelé
                                                </label>
                                            </div>
                                        </div>
                                        
                                        <div class="mb-4">
                                            <h6>Notifications SMS</h6>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" 
                                                       name="sms_on_ticket_called" id="smsCalled"/>
                                                <label class="form-check-label" for="smsCalled">
                                                    SMS quand le ticket est appelé
                                                </label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" 
                                                       name="sms_position_update" id="smsPosition"/>
                                                <label class="form-check-label" for="smsPosition">
                                                    SMS de mise à jour de position
                                                </label>
                                            </div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">Template SMS personnalisé</label>
                                            <textarea class="form-control" name="sms_template" rows="3"
                                                      placeholder="Votre ticket #{ticket_number} pour {service_name} est appelé!"></textarea>
                                        </div>
                                        
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fa fa-save me-2"></i>Sauvegarder Notifications
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Onglet Références -->
                        <div class="tab-pane fade" id="references" role="tabpanel">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title">Configuration des Références</h5>
                                    
                                    <form id="referencesSettingsForm">
                                        <div class="mb-3">
                                            <label class="form-label">Format des références principales</label>
                                            <input type="text" class="form-control" 
                                                   name="reference_format" 
                                                   value="QUE-{YYYY}-{MM}-{###}"
                                                   placeholder="Ex: QUE-{YYYY}-{MM}-{###}"/>
                                            <div class="form-text">
                                                Utilisez {YYYY} pour l'année, {MM} pour le mois, {###} pour le numéro séquentiel
                                            </div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">Longueur des références courtes</label>
                                            <select class="form-select" name="short_reference_length">
                                                <option value="4">4 caractères</option>
                                                <option value="5" selected="selected">5 caractères</option>
                                                <option value="6">6 caractères</option>
                                            </select>
                                        </div>
                                        
                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="checkbox" 
                                                   name="auto_generate_references" id="autoGenerate" checked="checked"/>
                                            <label class="form-check-label" for="autoGenerate">
                                                Générer automatiquement les références pour les nouveaux tickets
                                            </label>
                                        </div>
                                        
                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="checkbox" 
                                                   name="require_unique_references" id="requireUnique" checked="checked"/>
                                            <label class="form-check-label" for="requireUnique">
                                                Assurer l'unicité des références
                                            </label>
                                        </div>
                                        
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fa fa-save me-2"></i>Sauvegarder Références
                                        </button>
                                        
                                        <button type="button" class="btn btn-info ms-2" onclick="testReferenceGeneration()">
                                            <i class="fa fa-test me-2"></i>Tester la Génération
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Onglet Maintenance -->
                        <div class="tab-pane fade" id="maintenance" role="tabpanel">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title">Paramètres de Maintenance</h5>
                                    
                                    <div class="mb-4">
                                        <h6>Nettoyage Automatique</h6>
                                        <div class="mb-3">
                                            <label class="form-label">Supprimer les tickets annulés après (jours)</label>
                                            <input type="number" class="form-control" 
                                                   name="cleanup_cancelled_days" value="30" min="1" max="365"/>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">Supprimer les tickets servis après (jours)</label>
                                            <input type="number" class="form-control" 
                                                   name="cleanup_served_days" value="90" min="1" max="365"/>
                                        </div>
                                        
                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="checkbox" 
                                                   name="enable_auto_cleanup" id="autoCleanup"/>
                                            <label class="form-check-label" for="autoCleanup">
                                                Activer le nettoyage automatique quotidien
                                            </label>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-4">
                                        <h6>Sauvegarde des Données</h6>
                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="checkbox" 
                                                   name="enable_daily_backup" id="dailyBackup"/>
                                            <label class="form-check-label" for="dailyBackup">
                                                Sauvegarde quotidienne automatique
                                            </label>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">Conserver les sauvegardes (jours)</label>
                                            <input type="number" class="form-control" 
                                                   name="backup_retention_days" value="7" min="1" max="30"/>
                                        </div>
                                    </div>
                                    
                                    <button type="button" class="btn btn-primary" onclick="saveMaintenanceSettings()">
                                        <i class="fa fa-save me-2"></i>Sauvegarder
                                    </button>
                                    
                                    <button type="button" class="btn btn-warning ms-2" onclick="runMaintenance()">
                                        <i class="fa fa-wrench me-2"></i>Lancer Maintenance
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Scripts de configuration -->
            <script>
                // Gestion des formulaires de configuration
                document.addEventListener('DOMContentLoaded', function() {
                    // Chargement des paramètres existants
                    loadCurrentSettings();
                    
                    // Gestion des soumissions de formulaires
                    document.getElementById('generalSettingsForm').addEventListener('submit', function(e) {
                        e.preventDefault();
                        saveGeneralSettings();
                    });
                    
                    document.getElementById('notificationSettingsForm').addEventListener('submit', function(e) {
                        e.preventDefault();
                        saveNotificationSettings();
                    });
                    
                    document.getElementById('referencesSettingsForm').addEventListener('submit', function(e) {
                        e.preventDefault();
                        saveReferencesSettings();
                    });
                });
                
                function loadCurrentSettings() {
                    // Charger les paramètres depuis le serveur
                    fetch('/queue/admin/settings', {
                        method: 'GET',
                        headers: {'Content-Type': 'application/json'}
                    }).then(response => response.json())
                      .then(data => {
                          if (data.success) {
                              populateFormWithSettings(data.settings);
                          }
                      });
                }
                
                function saveGeneralSettings() {
                    const formData = new FormData(document.getElementById('generalSettingsForm'));
                    const settings = Object.fromEntries(formData);
                    
                    fetch('/queue/admin/settings/general', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(settings)
                    }).then(response => response.json())
                      .then(data => {
                          if (data.success) {
                              showNotification('Paramètres généraux sauvegardés', 'success');
                          } else {
                              showNotification('Erreur: ' + data.error, 'error');
                          }
                      });
                }
                
                function testReferenceGeneration() {
                    const format = document.querySelector('[name="reference_format"]').value;
                    
                    fetch('/queue/admin/test_reference', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({format: format})
                    }).then(response => response.json())
                      .then(data => {
                          if (data.success) {
                              alert('Exemple de référence: ' + data.example);
                          } else {
                              alert('Erreur: ' + data.error);
                          }
                      });
                }
                
                function showNotification(message, type) {
                    // Affichage de notifications toast
                    const notification = document.createElement('div');
                    notification.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show`;
                    notification.style.position = 'fixed';
                    notification.style.top = '20px';
                    notification.style.right = '20px';
                    notification.style.zIndex = '9999';
                    notification.innerHTML = `
                        ${message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;
                    
                    document.body.appendChild(notification);
                    
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 5000);
                }
            </script>
        </t>
    </template>

    <!-- ========================================
         TEMPLATES D'AIDE ET DOCUMENTATION
         ======================================== -->
    
    <!-- Template d'aide utilisateur -->
    <template id="help_template" name="Aide et Documentation">
        <t t-call="website.layout">
            <!-- Appel des assets -->
            <t t-call="queue_management.queue_assets_common"/>
            <div id="wrap" class="oe_structure oe_empty">
                <div class="container mt-4">
                    <div class="row">
                        <div class="col-12">
                            <h2 class="mb-4">
                                <i class="fa fa-question-circle me-2"></i>
                                Aide - Système de Files d'Attente
                            </h2>
                        </div>
                    </div>
                    
                    <!-- Navigation de l'aide -->
                    <div class="row">
                        <div class="col-md-3">
                            <div class="card">
                                <div class="card-header">
                                    <h5>Sections d'Aide</h5>
                                </div>
                                <div class="list-group list-group-flush">
                                    <a href="#getting-started" class="list-group-item list-group-item-action">
                                        <i class="fa fa-play me-2"></i>Prise en Main
                                    </a>
                                    <a href="#taking-ticket" class="list-group-item list-group-item-action">
                                        <i class="fa fa-ticket me-2"></i>Prendre un Ticket
                                    </a>
                                    <a href="#tracking-ticket" class="list-group-item list-group-item-action">
                                        <i class="fa fa-search me-2"></i>Suivre mon Ticket
                                    </a>
                                    <a href="#references" class="list-group-item list-group-item-action">
                                        <i class="fa fa-link me-2"></i>Les Références
                                    </a>
                                    <a href="#mobile-usage" class="list-group-item list-group-item-action">
                                        <i class="fa fa-mobile me-2"></i>Usage Mobile
                                    </a>
                                    <a href="#troubleshooting" class="list-group-item list-group-item-action">
                                        <i class="fa fa-wrench me-2"></i>Dépannage
                                    </a>
                                    <a href="#admin-guide" class="list-group-item list-group-item-action">
                                        <i class="fa fa-cog me-2"></i>Guide Admin
                                    </a>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-9">
                            <!-- Section Prise en Main -->
                            <div id="getting-started" class="card mb-4">
                                <div class="card-header">
                                    <h4><i class="fa fa-play me-2"></i>Prise en Main</h4>
                                </div>
                                <div class="card-body">
                                    <h5>Bienvenue dans le système de files d'attente!</h5>
                                    <p>Ce système vous permet de gérer efficacement l'attente dans vos services.</p>
                                    
                                    <h6>Fonctionnalités principales:</h6>
                                    <ul>
                                        <li><strong>Prise de ticket digitale</strong> - Plus besoin d'imprimantes complexes</li>
                                        <li><strong>Suivi en temps réel</strong> - Connaissez votre position à tout moment</li>
                                        <li><strong>Références uniques</strong> - Système de références pour un suivi facilité</li>
                                        <li><strong>Notifications intelligentes</strong> - Email et SMS quand c'est votre tour</li>
                                        <li><strong>Interface mobile</strong> - Optimisé pour smartphones et tablettes</li>
                                    </ul>
                                    
                                    <div class="alert alert-info">
                                        <i class="fa fa-lightbulb me-2"></i>
                                        <strong>Astuce:</strong> Gardez votre référence de ticket précieusement - 
                                        elle vous permet de retrouver votre ticket même si vous fermez votre navigateur!
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Section Prendre un Ticket -->
                            <div id="taking-ticket" class="card mb-4">
                                <div class="card-header">
                                    <h4><i class="fa fa-ticket me-2"></i>Prendre un Ticket</h4>
                                </div>
                                <div class="card-body">
                                    <h5>Comment prendre un ticket?</h5>
                                    
                                    <div class="row">
                                        <div class="col-md-6">
                                            <h6>Étape 1: Choisir le service</h6>
                                            <p>Sur la page d'accueil, sélectionnez le service pour lequel vous souhaitez un ticket. 
                                               Vérifiez que le service est ouvert (indicateur vert).</p>
                                            
                                            <h6>Étape 2: Remplir vos informations</h6>
                                            <p>Vous pouvez optionnellement fournir:</p>
                                            <ul>
                                                <li>Votre nom</li>
                                                <li>Votre numéro de téléphone (pour les SMS)</li>
                                                <li>Votre email (pour les notifications)</li>
                                            </ul>
                                            
                                            <h6>Étape 3: Confirmer</h6>
                                            <p>Cliquez sur "Prendre un ticket" et vous recevrez immédiatement:</p>
                                            <ul>
                                                <li>Un numéro de ticket unique</li>
                                                <li>Une référence de suivi</li>
                                                <li>Votre position dans la file</li>
                                                <li>Le temps d'attente estimé</li>
                                            </ul>
                                        </div>
                                        
                                        <div class="col-md-6">
                                            <div class="card bg-light">
                                                <div class="card-body">
                                                    <h6><i class="fa fa-info-circle me-2"></i>Informations importantes</h6>
                                                    <ul class="mb-0">
                                                        <li>Conservez votre référence de ticket</li>
                                                        <li>Les notifications nécessitent un email/téléphone</li>
                                                        <li>Vous pouvez imprimer votre ticket si besoin</li>
                                                        <li>Le QR code permet un accès rapide</li>
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Section Suivi -->
                            <div id="tracking-ticket" class="card mb-4">
                                <div class="card-header">
                                    <h4><i class="fa fa-search me-2"></i>Suivre mon Ticket</h4>
                                </div>
                                <div class="card-body">
                                    <h5>Comment suivre l'évolution de mon ticket?</h5>
                                    
                                    <div class="row">
                                        <div class="col-md-8">
                                            <h6>Méthodes de suivi:</h6>
                                            
                                            <div class="mb-3">
                                                <strong>1. Lien direct de confirmation</strong>
                                                <p>Après création, vous recevez un lien direct vers votre ticket. 
                                                   Mettez-le en favoris!</p>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <strong>2. QR Code</strong>
                                                <p>Scannez le QR code de votre ticket avec votre smartphone pour 
                                                   accéder rapidement au suivi.</p>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <strong>3. Recherche par référence</strong>
                                                <p>Utilisez la fonction "Rechercher mon ticket" avec votre référence 
                                                   (ex: QUE-2024-001-ABC) ou votre code court.</p>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <strong>4. Notifications automatiques</strong>
                                                <p>Si vous avez fourni votre email/téléphone, vous recevrez 
                                                   des notifications quand c'est votre tour.</p>
                                            </div>
                                        </div>
                                        
                                        <div class="col-md-4">
                                            <div class="card border-primary">
                                                <div class="card-body text-center">
                                                    <h5>États de ticket</h5>
                                                    <div class="mb-2">
                                                        <span class="badge bg-warning">En attente</span>
                                                        <small class="d-block">Votre tour approche</small>
                                                    </div>
                                                    <div class="mb-2">
                                                        <span class="badge bg-success">Appelé</span>
                                                        <small class="d-block">Présentez-vous!</small>
                                                    </div>
                                                    <div class="mb-2">
                                                        <span class="badge bg-info">Servi</span>
                                                        <small class="d-block">Service terminé</small>
                                                    </div>
                                                    <div class="mb-2">
                                                        <span class="badge bg-danger">Annulé</span>
                                                        <small class="d-block">Ticket annulé</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Section Références -->
                            <div id="references" class="card mb-4">
                                <div class="card-header">
                                    <h4><i class="fa fa-link me-2"></i>Système de Références</h4>
                                </div>
                                <div class="card-body">
                                    <h5>Comprendre les références de tickets</h5>
                                    
                                    <div class="row">
                                        <div class="col-md-6">
                                            <h6>Types de références:</h6>
                                            
                                            <div class="mb-3">
                                                <strong>Référence principale</strong>
                                                <br/>
                                                <code>QUE-2024-12-001</code>
                                                <p class="small text-muted">
                                                    Format: PREFIX-ANNÉE-MOIS-NUMÉRO<br/>
                                                    Référence complète et unique
                                                </p>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <strong>Code court</strong>
                                                <br/>
                                                <code>AB7K9</code>
                                                <p class="small text-muted">
                                                    5 caractères alphanumériques<br/>
                                                    Plus facile à saisir sur mobile
                                                </p>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <strong>Numéro de ticket</strong>
                                                <br/>
                                                <code>#123</code>
                                                <p class="small text-muted">
                                                    Numéro séquentiel par service<br/>
                                                    Affiché en grand sur votre ticket
                                                </p>
                                            </div>
                                        </div>
                                        
                                        <div class="col-md-6">
                                            <div class="alert alert-info">
                                                <h6><i class="fa fa-question-circle me-2"></i>Pourquoi des références?</h6>
                                                <ul class="mb-0">
                                                    <li>Retrouver facilement votre ticket</li>
                                                    <li>Partager votre position avec d'autres</li>
                                                    <li>Annuler votre ticket si nécessaire</li>
                                                    <li>Support client plus efficace</li>
                                                    <li>Traçabilité complète</li>
                                                </ul>
                                            </div>
                                            
                                            <div class="card bg-light">
                                                <div class="card-body">
                                                    <h6>Conseils d'utilisation:</h6>
                                                    <ul class="mb-0 small">
                                                        <li>Sauvegardez la référence dans vos notes</li>
                                                        <li>Utilisez le code court pour la saisie rapide</li>
                                                        <li>Le QR code contient la référence complète</li>
                                                        <li>Les références sont sensibles à la casse</li>
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Section Usage Mobile -->
                            <div id="mobile-usage" class="card mb-4">
                                <div class="card-header">
                                    <h4><i class="fa fa-mobile me-2"></i>Usage Mobile</h4>
                                </div>
                                <div class="card-body">
                                    <h5>Optimisé pour smartphones et tablettes</h5>
                                    
                                    <div class="row">
                                        <div class="col-md-8">
                                            <h6>Fonctionnalités mobiles:</h6>
                                            
                                            <ul>
                                                <li><strong>Interface tactile</strong> - Boutons larges et navigation intuitive</li>
                                                <li><strong>Affichage optimisé</strong> - Informations essentielles en grand</li>
                                                <li><strong>Auto-refresh</strong> - Mise à jour automatique de votre position</li>
                                                <li><strong>QR Scanner</strong> - Scannez votre ticket pour accès rapide</li>
                                                <li><strong>Notifications push</strong> - Restez informé même en arrière-plan</li>
                                                <li><strong>Mode hors-ligne</strong> - Consultez les infos même sans connexion</li>
                                            </ul>
                                            
                                            <h6>Conseils mobiles:</h6>
                                            <ul>
                                                <li>Gardez la page de suivi ouverte dans un onglet</li>
                                                <li>Activez les notifications de votre navigateur</li>
                                                <li>Utilisez le code court pour les recherches rapides</li>
                                                <li>Sauvegardez le lien de suivi en favori</li>
                                            </ul>
                                        </div>
                                        
                                        <div class="col-md-4">
                                            <div class="card border-success">
                                                <div class="card-body text-center">
                                                    <i class="fa fa-mobile fa-3x text-success mb-3"></i>
                                                    <h6>Accès rapide</h6>
                                                    <p class="small">
                                                        Ajoutez la page à votre écran d'accueil 
                                                        pour un accès instantané comme une app!
                                                    </p>
                                                    <div class="small text-muted">
                                                        Sur iOS: Partager → Ajouter à l'écran d'accueil<br/>
                                                        Sur Android: Menu → Ajouter à l'écran d'accueil
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Section Dépannage -->
                            <div id="troubleshooting" class="card mb-4">
                                <div class="card-header">
                                    <h4><i class="fa fa-wrench me-2"></i>Dépannage</h4>
                                </div>
                                <div class="card-body">
                                    <h5>Solutions aux problèmes courants</h5>
                                    
                                    <div class="accordion" id="troubleshootingAccordion">
                                        <div class="accordion-item">
                                            <h2 class="accordion-header">
                                                <button class="accordion-button collapsed" type="button" 
                                                        data-bs-toggle="collapse" data-bs-target="#problem1">
                                                    Je ne trouve plus mon ticket
                                                </button>
                                            </h2>
                                            <div id="problem1" class="accordion-collapse collapse">
                                                <div class="accordion-body">
                                                    <strong>Solutions:</strong>
                                                    <ul>
                                                        <li>Utilisez la fonction "Rechercher mon ticket" avec votre référence</li>
                                                        <li>Vérifiez vos emails si vous en avez fourni un</li>
                                                        <li>Scannez le QR code de votre ticket imprimé</li>
                                                        <li>Contactez l'accueil avec votre nom et l'heure de création</li>
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="accordion-item">
                                            <h2 class="accordion-header">
                                                <button class="accordion-button collapsed" type="button" 
                                                        data-bs-toggle="collapse" data-bs-target="#problem2">
                                                    Ma position ne se met pas à jour
                                                </button>
                                            </h2>
                                            <div id="problem2" class="accordion-collapse collapse">
                                                <div class="accordion-body">
                                                    <strong>Solutions:</strong>
                                                    <ul>
                                                        <li>Actualisez la page manuellement (bouton "Actualiser")</li>
                                                        <li>Vérifiez votre connexion internet</li>
                                                        <li>Fermez et rouvrez votre navigateur</li>
                                                        <li>Essayez sur un autre appareil</li>
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="accordion-item">
                                            <h2 class="accordion-header">
                                                <button class="accordion-button collapsed" type="button" 
                                                        data-bs-toggle="collapse" data-bs-target="#problem3">
                                                    Je n'arrive pas à prendre un ticket
                                                </button>
                                            </h2>
                                            <div id="problem3" class="accordion-collapse collapse">
                                                <div class="accordion-body">
                                                    <strong>Vérifications:</strong>
                                                    <ul>
                                                        <li>Le service est-il ouvert? (indicateur vert)</li>
                                                        <li>Votre connexion internet fonctionne-t-elle?</li>
                                                        <li>Avez-vous désactivé JavaScript?</li>
                                                        <li>Essayez avec un autre navigateur</li>
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="accordion-item">
                                            <h2 class="accordion-header">
                                                <button class="accordion-button collapsed" type="button" 
                                                        data-bs-toggle="collapse" data-bs-target="#problem4">
                                                    Je n'ai pas reçu de notifications
                                                </button>
                                            </h2>
                                            <div id="problem4" class="accordion-collapse collapse">
                                                <div class="accordion-body">
                                                    <strong>Vérifications:</strong>
                                                    <ul>
                                                        <li>Avez-vous fourni un email/téléphone valide?</li>
                                                        <li>Vérifiez vos spams/courriers indésirables</li>
                                                        <li>Les notifications peuvent prendre quelques minutes</li>
                                                        <li>Vérifiez les paramètres de votre téléphone (SMS bloqués?)</li>
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Section Admin -->
                            <div id="admin-guide" class="card mb-4">
                                <div class="card-header">
                                    <h4><i class="fa fa-cog me-2"></i>Guide Administrateur</h4>
                                </div>
                                <div class="card-body">
                                    <div class="alert alert-warning">
                                        <i class="fa fa-lock me-2"></i>
                                        Cette section est réservée aux administrateurs du système.
                                    </div>
                                    
                                    <h5>Fonctionnalités administrateur:</h5>
                                    
                                    <div class="row">
                                        <div class="col-md-6">
                                            <h6>Gestion des services:</h6>
                                            <ul>
                                                <li>Créer et configurer les services</li>
                                                <li>Ouvrir/fermer les services</li>
                                                <li>Appeler les tickets suivants</li>
                                                <li>Gérer les files d'attente</li>
                                            </ul>
                                            
                                            <h6>Suivi et statistiques:</h6>
                                            <ul>
                                                <li>Tableau de bord en temps réel</li>
                                                <li>Statistiques détaillées</li>
                                                <li>Rapports d'activité</li>
                                                <li>Export des données</li>
                                            </ul>
                                        </div>
                                        
                                        <div class="col-md-6">
                                            <h6>Maintenance système:</h6>
                                            <ul>
                                                <li>Gestion des références</li>
                                                <li>Nettoyage des anciennes données</li>
                                                <li>Configuration des notifications</li>
                                                <li>Sauvegarde et restauration</li>
                                            </ul>
                                            
                                            <div class="card bg-light mt-3">
                                                <div class="card-body">
                                                    <h6>Accès administration:</h6>
                                                    <p class="mb-2">
                                                        <a href="/queue/admin" class="btn btn-sm btn-primary">
                                                            Tableau de bord admin
                                                        </a>
                                                    </p>
                                                    <small class="text-muted">
                                                        Connexion avec compte utilisateur Odoo requis
                                                    </small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Contact et support -->
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="card border-primary">
                                <div class="card-body text-center">
                                    <h5><i class="fa fa-support me-2"></i>Besoin d'aide supplémentaire?</h5>
                                    <p>Si vous ne trouvez pas la réponse à votre question dans cette aide, 
                                       n'hésitez pas à contacter notre support.</p>
                                    
                                    <div class="btn-group" role="group">
                                        <a href="/queue" class="btn btn-outline-primary">
                                            <i class="fa fa-home me-1"></i>Retour Accueil
                                        </a>
                                        <a href="/queue/admin" class="btn btn-outline-info">
                                            <i class="fa fa-cog me-1"></i>Administration
                                        </a>
                                        <button onclick="window.print()" class="btn btn-outline-secondary">
                                            <i class="fa fa-print me-1"></i>Imprimer l'aide
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Script pour la navigation smooth -->
            <script>
                document.addEventListener('DOMContentLoaded', function() {
                    // Navigation smooth vers les sections
                    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
                        anchor.addEventListener('click', function (e) {
                            e.preventDefault();
                            const target = document.querySelector(this.getAttribute('href'));
                            if (target) {
                                target.scrollIntoView({
                                    behavior: 'smooth',
                                    block: 'start'
                                });
                                
                                // Mettre à jour l'item actif dans la navigation
                                document.querySelectorAll('.list-group-item').forEach(item => {
                                    item.classList.remove('active');
                                });
                                this.classList.add('active');
                            }
                        });
                    });
                    
                    // Highlight de la section active pendant le scroll
                    window.addEventListener('scroll', function() {
                        const sections = document.querySelectorAll('[id]');
                        const scrollPos = window.pageYOffset || document.documentElement.scrollTop;
                        
                        sections.forEach(section => {
                            if (section.offsetTop &lt;= scrollPos + 100 &amp;&amp; 
                                section.offsetTop + section.offsetHeight > scrollPos + 100) {
                                
                                // Mettre à jour la navigation
                                document.querySelectorAll('.list-group-item').forEach(item => {
                                    item.classList.remove('active');
                                });
                                
                                const activeLink = document.querySelector(`a[href="#${section.id}"]`);
                                if (activeLink) {
                                    activeLink.classList.add('active');
                                }
                            }
                        });
                    });
                });
            </script>
        </t>
    </template>
</odoo>