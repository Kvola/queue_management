<odoo>
    <record id="menu_queue_management" model="website.menu">
        <field name="name">File d'attente</field>
        <field name="url">/queue</field>
        <field name="parent_id" ref="website.main_menu" />
        <field name="sequence">77</field>
    </record>
    <!-- Template d'accueil avec widgets améliorés -->
    <!-- CORRECTED TEMPLATES - Key fixes for common issues -->

    <!-- À ajouter dans le <head> de vos templates ou dans un template parent -->
    <template id="queue_assets_common" name="Queue Assets">
        <link rel="stylesheet" href="/queue_management/static/src/css/queue_scroll_fix.css"/>
        <script src="/queue_management/static/src/js/queue_scroll_manager.js"></script>
    </template>

    <!-- Fixed Hero Template with proper syntax -->
    <template id="queue_home_template" name="Accueil Files d'Attente">
    <t t-call="website.layout">
        <!-- Appel des assets -->
        <t t-call="queue_management.queue_assets_common"/>
        <div id="wrap">
            <div class="container mt-4">
                <!-- Hero Section -->
                <div class="row mb-5">
                    <div class="col-12 text-center">
                        <h1 class="display-4 mb-3">
                            <i class="fa fa-users text-primary"/> Système de Files d'Attente
                        </h1>
                        <p class="lead text-muted">
                            Prenez votre ticket en ligne et évitez l'attente physique
                        </p>
                    </div>
                </div>

                <!-- Services disponibles -->
                <div class="row">
                    <t t-foreach="services" t-as="service">
                        <div class="col-md-6 col-lg-4 mb-4">
                            <div class="card h-100 shadow-sm">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5 class="card-title mb-0" t-field="service.name"/>
                                    <span t-if="service.is_open" class="badge bg-success">Ouvert</span>
                                    <span t-else="" class="badge bg-danger">Fermé</span>
                                </div>
                                <div class="card-body">
                                    <p class="card-text" t-if="service.description" t-field="service.description"/>
                                    
                                    <div class="queue-info mb-3">
                                        <div class="row text-center">
                                            <div class="col-4">
                                                <div class="stat-box">
                                                    <h4 class="text-primary mb-0" t-field="service.waiting_count"/>
                                                    <small class="text-muted">En attente</small>
                                                </div>
                                            </div>
                                            <div class="col-4">
                                                <div class="stat-box">
                                                    <h4 class="text-info mb-0">
                                                        <t t-esc="'%.0f' % (service.avg_waiting_time or 0)"/> min
                                                    </h4>
                                                    <small class="text-muted">Attente moy.</small>
                                                </div>
                                            </div>
                                            <div class="col-4">
                                                <div class="stat-box">
                                                    <h4 class="text-warning mb-0" t-field="service.total_tickets_today"/>
                                                    <small class="text-muted">Aujourd'hui</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="text-center">
                                        <a t-if="service.is_open" 
                                        t-attf-href="/queue/service/#{service.id}"
                                        class="btn btn-primary btn-lg w-100">
                                            <i class="fa fa-ticket"/> Prendre un Ticket
                                        </a>
                                        <button t-else="" class="btn btn-secondary btn-lg w-100" disabled="disabled">
                                            <i class="fa fa-lock"/> Service Fermé
                                        </button>
                                    </div>

                                    <!-- Horaires formatés améliorés -->
                                    <div class="mt-2 text-center">
                                        <small class="text-muted d-flex align-items-center justify-content-center">
                                            <i class="fa fa-clock-o me-1"/>
                                            <span>
                                                <!-- Formatage conditionnel des horaires -->
                                                <t t-if="service.working_hours_start and service.working_hours_end">
                                                    <!-- Format pour heures complètes (ex: 8:00 - 17:30) -->
                                                    <t t-set="start_hour" t-value="int(service.working_hours_start)"/>
                                                    <t t-set="start_minute" t-value="int((service.working_hours_start % 1) * 60)"/>
                                                    <t t-set="end_hour" t-value="int(service.working_hours_end)"/>
                                                    <t t-set="end_minute" t-value="int((service.working_hours_end % 1) * 60)"/>
                                                    
                                                    <t t-esc="'%02d:%02d' % (start_hour, start_minute)"/> - 
                                                    <t t-esc="'%02d:%02d' % (end_hour, end_minute)"/>
                                                </t>
                                                <t t-else="">
                                                    Horaires non définis
                                                </t>
                                            </span>
                                        </small>
                                    </div>

                                    <!-- Alternative simple si les champs sont déjà au bon format string -->
                                    <!--
                                    <div class="mt-2 text-center">
                                        <small class="text-muted d-flex align-items-center justify-content-center">
                                            <i class="fa fa-clock-o me-1"/>
                                            <span>
                                                <t t-if="service.working_hours_display">
                                                    <t t-field="service.working_hours_display"/>
                                                </t>
                                                <t t-else="">
                                                    <t t-field="service.working_hours_start"/> - <t t-field="service.working_hours_end"/>
                                                </t>
                                            </span>
                                        </small>
                                    </div>
                                    -->
                                </div>
                            </div>
                        </div>
                    </t>
                </div>

                <!-- Section information -->
                <div class="row mt-5">
                    <div class="col-12">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h5><i class="fa fa-question-circle text-info"/> Comment ça marche ?</h5>
                                <div class="row">
                                    <div class="col-md-3 text-center mb-3">
                                        <i class="fa fa-mouse-pointer fa-2x text-primary mb-2"/>
                                        <h6>1. Choisissez</h6>
                                        <small>Sélectionnez votre service</small>
                                    </div>
                                    <div class="col-md-3 text-center mb-3">
                                        <i class="fa fa-ticket fa-2x text-info mb-2"/>
                                        <h6>2. Prenez</h6>
                                        <small>Obtenez votre ticket</small>
                                    </div>
                                    <div class="col-md-3 text-center mb-3">
                                        <i class="fa fa-clock-o fa-2x text-warning mb-2"/>
                                        <h6>3. Attendez</h6>
                                        <small>Suivez votre position</small>
                                    </div>
                                    <div class="col-md-3 text-center mb-3">
                                        <i class="fa fa-check fa-2x text-success mb-2"/>
                                        <h6>4. Présentez-vous</h6>
                                        <small>Quand vous êtes appelé(e)</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </t>
</template>

    <!-- Fixed Service Detail Template -->
    <template id="queue_service_template" name="File d'Attente Service">
        <t t-call="website.layout">
            <!-- Appel des assets -->
        <t t-call="queue_management.queue_assets_common"/>
            <div id="wrap">
                <div class="container mt-4">
                    <div class="row">
                        <div class="col-lg-8">
                            <h1 t-field="service.name"/>
                            <p class="lead" t-if="service.description" t-field="service.description"/>

                            <!-- Statistiques -->
                            <div class="card mb-4">
                                <div class="card-body">
                                    <div class="row text-center">
                                        <div class="col-3">
                                            <h3 class="text-primary" id="waiting-count" t-field="service.waiting_count"/>
                                            <small>En attente</small>
                                        </div>
                                        <div class="col-3">
                                            <h3 class="text-info" id="current-ticket">
                                                #<span t-esc="service.current_ticket_number or 0"/>
                                            </h3>
                                            <small>Ticket actuel</small>
                                        </div>
                                        <div class="col-3">
                                            <h3 class="text-warning" id="avg-wait">
                                                <span t-esc="'%.0f' % (service.avg_waiting_time or 0)"/> min
                                            </h3>
                                            <small>Attente moyenne</small>
                                        </div>
                                        <div class="col-3">
                                            <h3 class="text-success" id="next-ticket">
                                                #<span t-esc="service.next_ticket_number or 1"/>
                                            </h3>
                                            <small>Prochain ticket</small>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Liste des tickets en attente -->
                            <div class="card">
                                <div class="card-header">
                                    <h5>File d'Attente</h5>
                                </div>
                                <div class="card-body">
                                    <div id="queue-list">
                                        <t t-if="waiting_tickets">
                                            <div class="list-group">
                                                <t t-foreach="waiting_tickets" t-as="ticket">
                                                    <t t-if="ticket_index &lt; 10">
                                                        <div class="list-group-item d-flex justify-content-between align-items-center">
                                                            <div>
                                                                <strong>Ticket #<span t-field="ticket.ticket_number"/></strong>
                                                                <t t-if="ticket.customer_name"> - <span t-field="ticket.customer_name"/></t>
                                                            </div>
                                                            <div>
                                                                <span class="badge bg-info">
                                                                    ~<span t-esc="'%.0f' % (ticket.estimated_wait_time or 0)"/> min
                                                                </span>
                                                            </div>
                                                        </div>
                                                    </t>
                                                </t>
                                            </div>
                                        </t>
                                        <t t-else="">
                                            <div class="text-center text-muted py-4">
                                                <i class="fa fa-check-circle fa-3x mb-3"/>
                                                <p>Aucun client en attente</p>
                                            </div>
                                        </t>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Sidebar - Prendre un ticket -->
                        <div class="col-lg-4">
                            <div class="card sticky-top">
                                <div class="card-header bg-primary text-white">
                                    <h5 class="mb-0">Prendre un Ticket</h5>
                                </div>
                                <div class="card-body">
                                    <t t-if="service.is_open">
                                        <form method="post" action="/queue/take_ticket_http">
                                            <input type="hidden" name="service_id" t-att-value="service.id"/>
                                            <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                                            
                                            <div class="mb-3">
                                                <label for="customer_name" class="form-label">Nom (optionnel)</label>
                                                <input type="text" class="form-control" id="customer_name" name="customer_name"/>
                                            </div>
                                            <div class="mb-3">
                                                <label for="customer_phone" class="form-label">Téléphone (optionnel)</label>
                                                <input type="tel" class="form-control" id="customer_phone" name="customer_phone"/>
                                            </div>
                                            <div class="mb-3">
                                                <label for="customer_email" class="form-label">Email (optionnel)</label>
                                                <input type="email" class="form-control" id="customer_email" name="customer_email"/>
                                            </div>
                                            
                                            <button type="submit" class="btn btn-primary btn-lg w-100">
                                                <i class="fa fa-ticket"/> Prendre mon Ticket
                                            </button>
                                        </form>
                                    </t>
                                    <t t-else="">
                                        <div class="alert alert-warning text-center">
                                            <i class="fa fa-clock-o fa-2x mb-2"/>
                                            <h5>Service Fermé</h5>
                                            <p class="mb-0">
                                                Horaires: <span t-field="service.working_hours_start"/>h - <span t-field="service.working_hours_end"/>h
                                            </p>
                                        </div>
                                    </t>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </t>
    </template>

    <!-- Simplified My Ticket Template -->
    <template id="my_ticket_template" name="Mon Ticket">
        <t t-call="website.layout">
            <!-- Appel des assets -->
        <t t-call="queue_management.queue_assets_common"/>
            <div id="wrap">
                <div class="container mt-4">
                    <div class="row justify-content-center">
                        <div class="col-lg-8">
                            <div class="text-center mb-4">
                                <h1>Suivi de Ticket</h1>
                                <h2 class="text-primary">#<span t-field="ticket.ticket_number"/></h2>
                                <p class="lead">Service: <strong t-field="service.name"/></p>
                            </div>

                            <!-- Status Card -->
                            <div class="card mb-4">
                                <div class="card-body">
                                    <div class="row text-center">
                                        <div class="col-md-3">
                                            <t t-if="ticket.state == 'waiting'">
                                                <i class="fa fa-clock-o fa-2x text-warning"/>
                                                <h4 class="text-warning">En Attente</h4>
                                            </t>
                                            <t t-elif="ticket.state == 'called'">
                                                <i class="fa fa-phone fa-2x text-info"/>
                                                <h4 class="text-info">Appelé !</h4>
                                            </t>
                                            <t t-elif="ticket.state == 'serving'">
                                                <i class="fa fa-user fa-2x text-primary"/>
                                                <h4 class="text-primary">En Service</h4>
                                            </t>
                                            <t t-elif="ticket.state == 'served'">
                                                <i class="fa fa-check-circle fa-2x text-success"/>
                                                <h4 class="text-success">Terminé</h4>
                                            </t>
                                            <t t-elif="ticket.state == 'cancelled'">
                                                <i class="fa fa-times-circle fa-2x text-danger"/>
                                                <h4 class="text-danger">Annulé</h4>
                                            </t>
                                            <t t-else="">
                                                <i class="fa fa-question-circle fa-2x text-muted"/>
                                                <h4 class="text-muted">Statut Inconnu</h4>
                                            </t>
                                        </div>
                                        
                                        <div class="col-md-3" t-if="ticket.state == 'waiting' and position > 0">
                                            <h3 class="text-info" t-esc="position"/>
                                            <small class="text-muted">Position</small>
                                        </div>
                                        
                                        <div class="col-md-3" t-if="ticket.estimated_wait_time > 0 and ticket.state == 'waiting'">
                                            <h3 class="text-warning">
                                                <span t-esc="'%.0f' % ticket.estimated_wait_time"/> min
                                            </h3>
                                            <small class="text-muted">Temps estimé</small>
                                        </div>
                                        
                                        <div class="col-md-3">
                                            <h3 class="text-primary">
                                                #<span t-esc="service.current_ticket_number or 0"/>
                                            </h3>
                                            <small class="text-muted">Actuellement servi</small>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Cancel Button for active tickets -->
                            <div class="card mb-4" t-if="ticket.state in ['waiting', 'called']">
                                <div class="card-body text-center">
                                    <h5>Actions disponibles</h5>
                                    <button type="button" 
                                            class="btn btn-outline-danger"
                                            onclick="cancelTicket()">
                                        <i class="fa fa-times"/> Annuler mon ticket
                                    </button>
                                </div>
                            </div>

                            <!-- Navigation -->
                            <div class="text-center">
                                <a t-attf-href="/queue/service/#{service.id}" class="btn btn-outline-primary me-2">
                                    <i class="fa fa-arrow-left"/> Retour au service
                                </a>
                                <a href="/queue" class="btn btn-outline-secondary">
                                    <i class="fa fa-home"/> Accueil
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <script>
                function cancelTicket() {
                    if (confirm('Êtes-vous sûr de vouloir annuler votre ticket ?')) {
                        fetch('/queue/cancel_ticket', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                jsonrpc: '2.0',
                                method: 'call',
                                params: {
                                    ticket_number: <t t-esc="ticket.ticket_number"/>,
                                    service_id: <t t-esc="service.id"/>,
                                    reason: 'Annulé par le client'
                                }
                            })
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.result &amp;&amp; data.result.success) {
                                alert('Ticket annulé avec succès');
                                window.location.reload();
                            } else {
                                alert('Erreur: ' + (data.result ? data.result.error : 'Erreur inconnue'));
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            alert('Erreur de communication');
                        });
                    }
                }
                
                // Auto-refresh pour tickets actifs
                <t t-if="ticket.state in ['waiting', 'called', 'serving']">
                    setInterval(function() {
                        window.location.reload();
                    }, 30000);
                </t>
            </script>
        </t>
    </template>

    <!-- Fixed Admin Dashboard Template -->
    <template id="admin_dashboard_template" name="Dashboard Administrateur">
        <t t-call="website.layout">
            <!-- Appel des assets -->
        <t t-call="queue_management.queue_assets_common"/>
            <div id="wrap">
                <div class="container-fluid mt-4">
                    <h1 class="mb-4">
                        <i class="fa fa-dashboard"/> Gestion des Files d'Attente
                    </h1>

                    <div class="row">
                        <t t-foreach="services" t-as="service">
                            <div class="col-lg-6 col-xl-4 mb-4">
                                <div class="card">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <h5 class="mb-0" t-field="service.name"/>
                                        <span t-if="service.is_open" class="badge bg-success">Ouvert</span>
                                        <span t-else="" class="badge bg-danger">Fermé</span>
                                    </div>
                                    <div class="card-body">
                                        <div class="row mb-3 text-center">
                                            <div class="col-6">
                                                <h3 class="text-primary" t-field="service.waiting_count"/>
                                                <small class="text-muted">En attente</small>
                                            </div>
                                            <div class="col-6">
                                                <h3 class="text-info">
                                                    #<t t-esc="service.current_ticket_number or 0"/>
                                                </h3>
                                                <small class="text-muted">Ticket actuel</small>
                                            </div>
                                        </div>

                                        <div class="d-grid gap-2">
                                            <button class="btn btn-primary btn-sm" onclick="generateTicket(&lt;t t-esc='service.id'/>)">
                                                <i class="fa fa-plus"/> Nouveau Ticket
                                            </button>
                                            
                                            <button class="btn btn-success btn-sm" onclick="callNext(&lt;t t-esc='service.id'/>)">
                                                <i class="fa fa-phone"/> Appeler Suivant
                                            </button>
                                            
                                            <button t-if="service.is_open" class="btn btn-warning btn-sm" onclick="toggleService(&lt;t t-esc='service.id'/>, false)">
                                                <i class="fa fa-pause"/> Fermer Service
                                            </button>
                                            <button t-else="" class="btn btn-success btn-sm" onclick="toggleService(&lt;t t-esc='service.id'/>, true)">
                                                <i class="fa fa-play"/> Ouvrir Service
                                            </button>
                                        </div>

                                        <!-- Prochains tickets -->
                                        <div class="mt-3">
                                            <h6>Prochains tickets:</h6>
                                            <t t-set="next_tickets" t-value="service.waiting_ticket_ids.sorted('ticket_number')[:3]"/>
                                            <t t-if="next_tickets">
                                                <t t-foreach="next_tickets" t-as="next_ticket">
                                                    <div class="d-flex justify-content-between align-items-center mb-2 p-2 bg-light rounded">
                                                        <span>
                                                            <strong>#<t t-field="next_ticket.ticket_number"/></strong>
                                                            <t t-if="next_ticket.customer_name"> - <t t-field="next_ticket.customer_name"/></t>
                                                        </span>
                                                        <button class="btn btn-sm btn-info" 
                                                                onclick="callSpecificTicket(&lt;t t-esc='next_ticket.id'/>)">
                                                            <i class="fa fa-phone"/> Appeler
                                                        </button>
                                                    </div>
                                                </t>
                                            </t>
                                            <t t-else="">
                                                <div class="text-center text-muted py-2">
                                                    <i class="fa fa-check-circle"/> Aucun ticket en attente
                                                </div>
                                            </t>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </t>
                    </div>
                </div>
            </div>

            <script>
                function adminAction(action, serviceId, ticketId) {
                    const data = {
                        action: action,
                        service_id: serviceId,
                        ticket_id: ticketId
                    };
                    
                    fetch('/queue/admin/action', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            jsonrpc: '2.0',
                            method: 'call',
                            params: data
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.result &amp;&amp; data.result.success) {
                            alert(data.result.message);
                            window.location.reload();
                        } else {
                            alert('Erreur: ' + (data.result ? data.result.error : 'Erreur inconnue'));
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Erreur de communication');
                    });
                }
                
                function generateTicket(serviceId) {
                    adminAction('generate_ticket', serviceId);
                }
                
                function callNext(serviceId) {
                    adminAction('call_next', serviceId);
                }
                
                function callSpecificTicket(ticketId) {
                    adminAction('call_next', null, ticketId);
                }
                
                function toggleService(serviceId, open) {
                    adminAction('toggle_service', serviceId);
                }
                
                // Auto-refresh every 30 seconds
                setInterval(function() {
                    window.location.reload();
                }, 30000);
            </script>
        </t>
    </template>

    <!-- Simplified Error Template -->
    <template id="error_template" name="Erreur">
        <t t-call="website.layout">
            <!-- Appel des assets -->
        <t t-call="queue_management.queue_assets_common"/>
            <div id="wrap">
                <div class="container mt-4">
                    <div class="row justify-content-center">
                        <div class="col-lg-6 text-center">
                            <i class="fa fa-exclamation-circle fa-5x text-danger mb-4"/>
                            <h1>Erreur</h1>
                            <p class="lead" t-esc="error_message or 'Une erreur est survenue'"/>
                            <a href="/queue" class="btn btn-primary">
                                <i class="fa fa-arrow-left"/> Retour aux files d'attente
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </t>
    </template>

    <!-- Simplified Ticket Confirmation Template -->
    <!-- Simplified Ticket Confirmation Template -->
    <template id="ticket_confirmation_template" name="Confirmation de Ticket">
        <t t-call="website.layout">
            <!-- Appel des assets -->
        <t t-call="queue_management.queue_assets_common"/>
            <div id="wrap">
                <div class="container mt-4">
                    <div class="row justify-content-center">
                        <div class="col-lg-8">
                            <div class="text-center mb-4">
                                <i class="fa fa-check-circle fa-5x text-success mb-3 animate__animated animate__bounceIn"/>
                                <h1 class="text-success">Ticket Créé avec Succès !</h1>
                                <h2 class="text-primary display-4">#<t t-esc="ticket.ticket_number"/></h2>
                            </div>
                            
                            <div class="card shadow-lg">
                                <div class="card-header bg-success text-white">
                                    <h5 class="mb-0">
                                        <i class="fa fa-ticket"></i> Détails de votre Ticket
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div class="row text-center mb-4">
                                        <div class="col-md-3">
                                            <div class="stat-card p-3 border rounded">
                                                <h3 class="text-primary mb-1">#<t t-esc="ticket.ticket_number"/></h3>
                                                <small class="text-muted">Numéro de ticket</small>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="stat-card p-3 border rounded">
                                                <h3 class="text-info mb-1" t-esc="position or 0"></h3>
                                                <small class="text-muted">Position dans la file</small>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="stat-card p-3 border rounded">
                                                <h3 class="text-warning mb-1">
                                                    ~<t t-esc="'%.0f' % (ticket.estimated_wait_time or 0)"/> min
                                                </h3>
                                                <small class="text-muted">Temps d'attente estimé</small>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="stat-card p-3 border rounded">
                                                <h3 class="text-success mb-1" t-esc="service.name"/>
                                                <small class="text-muted">Service</small>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="alert alert-info">
                                        <i class="fa fa-info-circle"></i>
                                        <strong>Important :</strong> Gardez ce numéro de ticket et présentez-vous quand votre numéro sera appelé.
                                        Vous pouvez suivre l'avancement en temps réel via le lien ci-dessous.
                                    </div>

                                    <!-- Zone d'actions principales -->
                                    <div class="row mb-4">
                                        <div class="col-md-4 mb-3">
                                            <button onclick="printTicket()" class="btn btn-success btn-lg w-100">
                                                <i class="fa fa-print"></i> Imprimer Ticket
                                            </button>
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <a t-att-href="track_url or ('/queue/my_ticket/' + str(ticket.ticket_number) + '/' + str(service.id))" 
                                            class="btn btn-primary btn-lg w-100">
                                                <i class="fa fa-search"></i> Suivre mon Ticket
                                            </a>
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <button onclick="shareTicket()" class="btn btn-outline-info btn-lg w-100">
                                                <i class="fa fa-share"></i> Partager
                                            </button>
                                        </div>
                                    </div>

                                    <!-- QR Code pour suivi mobile -->
                                    <div class="text-center mb-4">
                                        <div class="qr-code-section p-3 bg-light rounded">
                                            <h6>Suivez votre ticket depuis votre mobile</h6>
                                            <t t-set="track_url_full" t-value="request.httprequest.host_url + 'queue/my_ticket/' + str(ticket.ticket_number) + '/' + str(service.id)"/>
                                            <img t-attf-src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&amp;data=#{track_url_full}" 
                                                alt="QR Code Suivi" class="img-fluid mb-2"/>
                                            <br/>
                                            <small class="text-muted">Scannez avec votre téléphone</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Actions secondaires -->
                            <div class="row mt-4">
                                <div class="col-md-6 mb-3">
                                    <a t-att-href="'/queue/service/' + str(service.id)" class="btn btn-outline-secondary w-100">
                                        <i class="fa fa-arrow-left"></i> Retour au service
                                    </a>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <a href="/queue" class="btn btn-outline-primary w-100">
                                        <i class="fa fa-home"></i> Tous les services
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Variables JavaScript pour éviter les problèmes d'échappement -->
            <script t-nocache="1">
                // Variables globales définies côté serveur
                window.ticketData = {
                    ticketNumber: '<t t-esc="ticket.ticket_number"/>',
                    serviceId: '<t t-esc="service.id"/>',
                    serviceName: '<t t-esc="service.name"/>',
                    trackUrl: '<t t-esc="request.httprequest.host_url"/>queue/my_ticket/<t t-esc="ticket.ticket_number"/>/<t t-esc="service.id"/>'
                };
            </script>

            <script>
                // Fonction d'impression dans une nouvelle fenêtre
                function printTicket() {
                    const printUrl = `/queue/print_ticket/${window.ticketData.ticketNumber}/${window.ticketData.serviceId}?auto_print=1&amp;auto_close=1`;
                    
                    // Ouvrir dans une nouvelle fenêtre optimisée pour l'impression
                    const printWindow = window.open(
                        printUrl, 
                        'printTicket', 
                        'width=600,height=800,scrollbars=yes,resizable=yes,toolbar=no,menubar=no,location=no'
                    );
                    
                    if (!printWindow) {
                        // Si le popup est bloqué, rediriger dans le même onglet
                        alert('Les popups sont bloqués. Redirection vers la page d\'impression...');
                        window.open(printUrl, '_blank');
                    }
                }

                // Fonction de partage
                function shareTicket() {
                    if (navigator.share) {
                        // API Web Share si disponible
                        navigator.share({
                            title: `Ticket #${window.ticketData.ticketNumber} - ${window.ticketData.serviceName}`,
                            text: `Mon ticket de file d'attente #${window.ticketData.ticketNumber} pour ${window.ticketData.serviceName}`,
                            url: window.ticketData.trackUrl
                        }).catch(console.error);
                    } else {
                        // Fallback : copier le lien
                        if (navigator.clipboard) {
                            navigator.clipboard.writeText(window.ticketData.trackUrl).then(() => {
                                alert('Lien de suivi copié dans le presse-papier !');
                            }).catch(() => {
                                promptCopyLink(window.ticketData.trackUrl);
                            });
                        } else {
                            promptCopyLink(window.ticketData.trackUrl);
                        }
                    }
                }

                function promptCopyLink(url) {
                    const textArea = document.createElement('textarea');
                    textArea.value = url;
                    document.body.appendChild(textArea);
                    textArea.select();
                    try {
                        document.execCommand('copy');
                        alert('Lien de suivi copié !');
                    } catch (err) {
                        prompt('Copiez ce lien pour suivre votre ticket:', url);
                    }
                    document.body.removeChild(textArea);
                }

                // Auto-focus sur le bouton principal après 2 secondes
                setTimeout(() => {
                    const printBtn = document.querySelector('button[onclick="printTicket()"]');
                    if (printBtn) {
                        printBtn.focus();
                    }
                }, 2000);
            </script>

            <style>
                .stat-card {
                    transition: all 0.3s ease;
                    background: rgba(255,255,255,0.8);
                }
                
                .stat-card:hover {
                    transform: translateY(-2px);
                    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
                }
                
                .qr-code-section {
                    transition: all 0.3s ease;
                }
                
                .qr-code-section:hover {
                    background: #e9ecef !important;
                }
                
                .animate__bounceIn {
                    animation-duration: 1s;
                }
                
                @media (max-width: 768px) {
                    .display-4 {
                        font-size: 2.5rem;
                    }
                    
                    .stat-card {
                        margin-bottom: 1rem;
                    }
                }
            </style>
        </t>
    </template>

    <!-- Template principal des files d'attente -->
    <template id="queue_main_template" name="Files d'Attente">
        <t t-call="website.layout">
            <!-- Appel des assets -->
        <t t-call="queue_management.queue_assets_common"/>
            <div id="wrap">
                <div class="container mt-4">
                    <div class="row">
                        <div class="col-12">
                            <h1 class="text-center mb-4">Files d'Attente</h1>
                            <p class="text-center text-muted">
                                Prenez votre ticket en ligne et suivez votre position en temps réel
                            </p>
                        </div>
                    </div>
                    <div class="row">
                        <t t-foreach="services" t-as="service">
                            <div class="col-md-6 col-lg-4 mb-4">
                                <div class="card h-100">
                                    <div class="card-body">
                                        <h5 class="card-title">
                                            <t t-esc="service.name"/>
                                            <span t-if="service.is_open" class="badge badge-success ms-2">Ouvert</span>
                                            <span t-else="" class="badge badge-danger ms-2">Fermé</span>
                                        </h5>
                                        <p class="card-text" t-if="service.description">
                                            <t t-esc="service.description"/>
                                        </p>
                                        <div class="queue-stats mb-3">
                                            <div class="row">
                                                <div class="col-6">
                                                    <strong><t t-esc="service.waiting_count"/></strong>
                                                    <br/>
                                                    <small class="text-muted">En attente</small>
                                                </div>
                                                <div class="col-6">
                                                    <strong><t t-esc="round(service.avg_waiting_time, 0)"/>min</strong>
                                                    <br/>
                                                    <small class="text-muted">Attente moyenne</small>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="text-center">
                                            <a t-if="service.is_open" 
                                               t-attf-href="/queue/service/#{service.id}"
                                               class="btn btn-primary">
                                                Prendre un Ticket
                                            </a>
                                            <button t-else="" class="btn btn-secondary" disabled="">
                                                Service Fermé
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </t>
                    </div>
                </div>
            </div>
        </t>
    </template>

    <!-- Template pour ticket non trouvé -->
    <template id="ticket_not_found_template" name="Ticket Non Trouvé">
        <t t-call="website.layout">
            <!-- Appel des assets -->
        <t t-call="queue_management.queue_assets_common"/>
            <div id="wrap">
                <div class="container mt-4">
                    <div class="row justify-content-center">
                        <div class="col-lg-6 text-center">
                            <i class="fa fa-exclamation-triangle fa-5x text-warning mb-4"/>
                            <h1>Ticket Non Trouvé</h1>
                            <p class="lead">Le ticket que vous cherchez n'existe pas ou a expiré.</p>
                            <a href="/queue" class="btn btn-primary">
                                <i class="fa fa-arrow-left"/> Retour aux files d'attente
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </t>
    </template>

    <!-- Template d'impression de ticket -->
    <!-- Template d'impression de ticket sans header/footer -->
    <template id="print_ticket_template" name="Ticket à Imprimer">
        <html>
            <head>
                <meta charset="utf-8"/>
                <meta name="viewport" content="width=device-width, initial-scale=1"/>
                <title>Ticket #<t t-esc="ticket.ticket_number"/></title>
                
                <!-- Bootstrap CSS minimal pour le styling -->
                <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/css/bootstrap.min.css" rel="stylesheet"/>
                <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet"/>
                
                <!-- Styles spécifiques pour l'impression -->
                <style>
                    body {
                        margin: 0;
                        padding: 20px;
                        font-family: 'Courier New', monospace;
                        background: white;
                        color: black;
                    }
                    
                    .ticket-print {
                        background: white;
                        max-width: 400px;
                        margin: 0 auto;
                        border: 2px solid #000;
                        padding: 20px;
                        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                    }
                    
                    .display-3 {
                        font-size: 3rem;
                        font-weight: bold;
                        font-family: Arial, sans-serif;
                    }
                    
                    .qr-code-container img {
                        max-width: 100px;
                        height: auto;
                        border: 1px solid #ccc;
                    }
                    
                    /* Styles d'impression */
                    @media print {
                        * {
                            -webkit-print-color-adjust: exact !important;
                            color-adjust: exact !important;
                        }
                        
                        body {
                            margin: 0 !important;
                            padding: 0 !important;
                            background: white !important;
                        }
                        
                        .d-print-none {
                            display: none !important;
                        }
                        
                        .ticket-print {
                            border: 2px solid #000 !important;
                            page-break-inside: avoid;
                            width: 100%;
                            max-width: none;
                            font-size: 12px;
                            margin: 0;
                            padding: 15px;
                            box-shadow: none;
                        }
                        
                        .display-3 {
                            font-size: 2.5rem !important;
                            color: #000 !important;
                        }
                        
                        .qr-code-container img {
                            max-width: 80px !important;
                            height: auto !important;
                            border: 1px solid #000 !important;
                        }
                        
                        .text-primary { color: #0066cc !important; }
                        .text-muted { color: #666 !important; }
                        .text-warning { color: #ff6600 !important; }
                        .text-success { color: #009900 !important; }
                        .h4 { font-size: 1.5rem !important; color: #000 !important; }
                        
                        hr {
                            border-top: 1px solid #000 !important;
                        }
                        
                        /* Configuration de la page */
                        @page {
                            margin: 0.5in;
                            size: A4 portrait;
                        }
                    }
                    
                    /* Styles pour l'écran */
                    @media screen {
                        .print-controls {
                            position: fixed;
                            top: 20px;
                            right: 20px;
                            z-index: 1000;
                            background: rgba(255,255,255,0.95);
                            padding: 15px;
                            border-radius: 8px;
                            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                            border: 1px solid #ddd;
                        }
                        
                        .preview-notice {
                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                            color: white;
                            padding: 20px;
                            text-align: center;
                            border-radius: 0 0 10px 10px;
                        }
                    }
                    
                    /* Style pour le ticket */
                    .ticket-header {
                        border-bottom: 2px dashed #000;
                        padding-bottom: 15px;
                        margin-bottom: 15px;
                    }
                    
                    .ticket-number {
                        background: #f8f9fa;
                        border: 2px solid #000;
                        padding: 20px;
                        margin: 20px 0;
                        text-align: center;
                        border-radius: 10px;
                    }
                    
                    .ticket-footer {
                        border-top: 1px dashed #000;
                        padding-top: 15px;
                        margin-top: 15px;
                        font-size: 0.85em;
                    }
                    
                    @media print {
                        .ticket-number {
                            background: #f0f0f0 !important;
                            border: 2px solid #000 !important;
                        }
                    }
                </style>
            </head>
            
            <body>
                <!-- Contrôles d'impression (visible uniquement à l'écran) -->
                <div class="print-controls d-print-none">
                    <div class="d-flex flex-column gap-2">
                        <button onclick="printTicket()" class="btn btn-primary">
                            <i class="fa fa-print"></i> Imprimer
                        </button>
                        <button onclick="window.close()" class="btn btn-secondary">
                            <i class="fa fa-times"></i> Fermer
                        </button>
                        <button onclick="downloadPDF()" class="btn btn-outline-success">
                            <i class="fa fa-download"></i> PDF
                        </button>
                    </div>
                </div>

                <!-- Version écran avec aperçu -->
                <div class="preview-notice d-print-none">
                    <h3><i class="fa fa-print"></i> Aperçu d'impression</h3>
                    <p class="mb-0">Votre ticket est prêt à être imprimé</p>
                </div>

                <!-- Ticket imprimable -->
                <div class="ticket-print">
                    <div class="ticket-header">
                        <div class="text-center">
                            <h3 class="mb-1" t-esc="service.name"/>
                            <p class="text-muted mb-0">File d'attente numérique</p>
                            <small class="text-muted">
                                <i class="fa fa-map-marker-alt"></i> 
                                <t t-if="service.location" t-esc="service.location"/>
                                <t t-else="">Bureau d'accueil</t>
                            </small>
                        </div>
                    </div>
                    
                    <div class="ticket-number">
                        <h1 class="display-3 text-primary mb-1">
                            #<t t-esc="ticket.ticket_number"/>
                        </h1>
                        <p class="text-muted mb-0 fw-bold">VOTRE NUMÉRO DE TICKET</p>
                    </div>

                    <div class="row text-center mb-4">
                        <div class="col-6">
                            <div class="border-end">
                                <h4 class="text-info mb-1" t-esc="position"/>
                                <small class="text-muted">Position</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <h4 class="text-warning mb-1">
                                ~<t t-esc="'%.0f' % (ticket.estimated_wait_time or 0)"/> min
                            </h4>
                            <small class="text-muted">Attente estimée</small>
                        </div>
                    </div>

                    <div class="text-center mb-3">
                        <div class="row">
                            <div class="col-6">
                                <strong>Ticket actuel:</strong><br/>
                                <span class="h5 text-success">
                                    #<t t-esc="service.current_ticket_number or 0"/>
                                </span>
                            </div>
                            <div class="col-6">
                                <strong>En attente:</strong><br/>
                                <span class="h5 text-warning" t-esc="service.waiting_count"/>
                            </div>
                        </div>
                    </div>

                    <!-- Informations client si disponibles -->
                    <div t-if="ticket.customer_name or ticket.customer_phone" class="mb-3 p-2 bg-light rounded">
                        <strong>Client:</strong>
                        <div t-if="ticket.customer_name">
                            <i class="fa fa-user"></i> <span t-esc="ticket.customer_name"/>
                        </div>
                        <div t-if="ticket.customer_phone">
                            <i class="fa fa-phone"></i> <span t-esc="ticket.customer_phone"/>
                        </div>
                    </div>

                    <div class="ticket-footer">
                        <div class="row align-items-center">
                            <div class="col-8">
                                <div class="small text-muted">
                                    <div><strong>Créé:</strong> <t t-esc="ticket.created_time.strftime('%d/%m/%Y à %H:%M')"/></div>
                                    <div><strong>Imprimé:</strong> <span id="print-time"></span></div>
                                    <div class="mt-2 fw-bold">
                                        ⚠️ Gardez ce ticket jusqu'à ce que votre numéro soit appelé
                                    </div>
                                    <div class="mt-1">
                                        <i class="fa fa-clock"></i> 
                                        Horaires: <t t-esc="service.working_hours_start"/>h - <t t-esc="service.working_hours_end"/>h
                                    </div>
                                </div>
                            </div>
                            
                            <!-- QR Code pour le suivi -->
                            <div class="col-4 text-center" t-if="ticket.qr_code or ticket.ticket_number">
                                <div class="qr-code-container">
                                    <t t-set="qr_data" t-value="ticket.qr_code or f'{request.httprequest.host_url}queue/my_ticket/{ticket.ticket_number}/{service.id}'"/>
                                    <img t-attf-src="https://api.qrserver.com/v1/create-qr-code/?size=80x80&amp;data=#{qr_data}" 
                                        alt="QR Code" class="img-fluid"/>
                                    <small class="d-block mt-1 text-muted">Suivi en ligne</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Instructions importantes -->
                    <div class="mt-3 p-2 border rounded bg-light">
                        <div class="small">
                            <div class="fw-bold mb-1">📋 Instructions:</div>
                            <ul class="mb-0 ps-3">
                                <li>Présentez-vous quand votre numéro est appelé</li>
                                <li>Suivez l'affichage ou scannez le QR code</li>
                                <li>En cas de retard, votre ticket peut être reporté</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Navigation de retour (visible uniquement à l'écran) -->
                <div class="d-print-none text-center mt-4">
                    <div class="card">
                        <div class="card-body">
                            <h5>Actions disponibles</h5>
                            <div class="d-flex justify-content-center gap-2 flex-wrap">
                                <a t-att-href="'/queue/my_ticket/' + str(ticket.ticket_number) + '/' + str(service.id)" 
                                class="btn btn-outline-info">
                                    <i class="fa fa-search"></i> Suivre mon ticket
                                </a>
                                <a t-att-href="'/queue/service/' + str(service.id)" class="btn btn-outline-secondary">
                                    <i class="fa fa-arrow-left"></i> Retour au service
                                </a>
                                <a href="/queue" class="btn btn-outline-primary">
                                    <i class="fa fa-home"></i> Accueil
                                </a>
                            </div>
                        </div>
                    </div>
                </div>

                <script>
                    // Mise à jour de l'heure d'impression
                    function updatePrintTime() {
                        const now = new Date();
                        const timeString = now.toLocaleString('fr-FR');
                        const printTimeElement = document.getElementById('print-time');
                        if (printTimeElement) {
                            printTimeElement.textContent = timeString;
                        }
                    }

                    // Fonction d'impression optimisée
                    function printTicket() {
                        updatePrintTime();
                        
                        // Configuration d'impression spéciale
                        const beforePrint = function() {
                            document.body.style.visibility = 'hidden';
                            document.querySelector('.ticket-print').style.visibility = 'visible';
                        };
                        
                        const afterPrint = function() {
                            document.body.style.visibility = 'visible';
                        };
                        
                        window.addEventListener('beforeprint', beforePrint);
                        window.addEventListener('afterprint', afterPrint);
                        
                        // Lancer l'impression
                        window.print();
                        
                        // Nettoyer les listeners
                        setTimeout(() => {
                            window.removeEventListener('beforeprint', beforePrint);
                            window.removeEventListener('afterprint', afterPrint);
                        }, 1000);
                    }

                    // Fonction de téléchargement PDF (nécessite une route backend)
                    function downloadPDF() {
                        const ticketNumber = '<t t-esc="ticket.ticket_number"/>';
                        const serviceId = '<t t-esc="service.id"/>';
                        
                        // Créer un lien de téléchargement
                        const link = document.createElement('a');
                        link.href = `/queue/print_ticket_pdf/${ticketNumber}/${serviceId}`;
                        link.download = `ticket_${ticketNumber}.pdf`;
                        link.target = '_blank';
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                    }

                    // Initialisation
                    document.addEventListener('DOMContentLoaded', function() {
                        updatePrintTime();
                        
                        // Auto-print au chargement si paramètre présent
                        const urlParams = new URLSearchParams(window.location.search);
                        if (urlParams.get('auto_print') === '1') {
                            setTimeout(printTicket, 500);
                        }
                    });

                    // Fermer la fenêtre après impression (si ouverte dans un popup)
                    window.addEventListener('afterprint', function() {
                        if (window.opener &amp;&amp; window.location.search.includes('auto_close=1')) {
                            setTimeout(() => window.close(), 1000);
                        }
                    });

                    // Raccourcis clavier
                    document.addEventListener('keydown', function(e) {
                        if (e.ctrlKey &amp;&amp; e.key === 'p') {
                            e.preventDefault();
                            printTicket();
                        }
                        if (e.key === 'Escape' &amp;&amp; window.opener) {
                            window.close();
                        }
                    });
                </script>
            </body>
        </html>
    </template>

    <!-- Template de formulaire de feedback -->
    <template id="feedback_form_template" name="Formulaire de Feedback">
        <t t-call="website.layout">
            <!-- Appel des assets -->
        <t t-call="queue_management.queue_assets_common"/>
            <div id="wrap">
                <div class="container mt-4">
                    <div class="row justify-content-center">
                        <div class="col-lg-6">
                            <div class="text-center mb-4">
                                <i class="fa fa-star fa-3x text-warning mb-3"/>
                                <h1>Évaluez votre expérience</h1>
                                <p class="lead">Service: <strong t-esc="service.name"/></p>
                                <p class="text-muted">Ticket #<t t-esc="ticket.ticket_number"/></p>
                            </div>

                            <div class="card">
                                <div class="card-body">
                                    <form method="post" t-attf-action="/queue/feedback/#{ticket.id}">
                                        <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                                        
                                        <div class="mb-4">
                                            <label class="form-label">Comment évaluez-vous notre service ?</label>
                                            <div class="rating-stars text-center">
                                                <input type="radio" name="rating" value="1" id="star1"/>
                                                <label for="star1" class="star">⭐</label>
                                                
                                                <input type="radio" name="rating" value="2" id="star2"/>
                                                <label for="star2" class="star">⭐</label>
                                                
                                                <input type="radio" name="rating" value="3" id="star3"/>
                                                <label for="star3" class="star">⭐</label>
                                                
                                                <input type="radio" name="rating" value="4" id="star4"/>
                                                <label for="star4" class="star">⭐</label>
                                                
                                                <input type="radio" name="rating" value="5" id="star5"/>
                                                <label for="star5" class="star">⭐</label>
                                            </div>
                                        </div>

                                        <div class="mb-4">
                                            <label for="feedback" class="form-label">Commentaires (optionnel)</label>
                                            <textarea name="feedback" id="feedback" class="form-control" rows="4" 
                                                      placeholder="Partagez votre expérience et vos suggestions..."></textarea>
                                        </div>

                                        <div class="text-center">
                                            <button type="submit" class="btn btn-success btn-lg">
                                                <i class="fa fa-paper-plane"/> Envoyer mon évaluation
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>

                            <div class="text-center mt-3">
                                <a href="/queue" class="btn btn-outline-secondary">
                                    <i class="fa fa-arrow-left"/> Retour aux services
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <style>
                .rating-stars {
                    font-size: 2rem;
                }
                
                .rating-stars input[type="radio"] {
                    display: none;
                }
                
                .rating-stars label.star {
                    cursor: pointer;
                    margin: 0 5px;
                    transition: all 0.2s ease;
                    filter: grayscale(100%);
                }
                
                .rating-stars label.star:hover,
                .rating-stars input[type="radio"]:checked ~ label.star,
                .rating-stars input[type="radio"]:checked + label.star {
                    filter: grayscale(0%);
                    transform: scale(1.2);
                }
                
                .rating-stars input[type="radio"]:checked + label.star ~ label.star {
                    filter: grayscale(100%);
                    transform: scale(1);
                }
            </style>

            <script>
                odoo.define('queue_management.feedback_form', function (require) {
                    'use strict';

                    var publicWidget = require('web.public.widget');

                    publicWidget.registry.FeedbackForm = publicWidget.Widget.extend({
                        selector: '.rating-stars',
                        events: {
                            'change input[type="radio"]': '_onRatingChange',
                            'mouseover label.star': '_onStarHover',
                            'mouseout': '_onStarsMouseOut',
                        },

                        _onRatingChange: function (ev) {
                            var rating = $(ev.target).val();
                            this._highlightStars(rating);
                        },

                        _onStarHover: function (ev) {
                            var starValue = $(ev.target).prev('input').val();
                            this._highlightStars(starValue, true);
                        },

                        _onStarsMouseOut: function () {
                            var checkedValue = this.$('input[type="radio"]:checked').val();
                            this._highlightStars(checkedValue || 0);
                        },

                        _highlightStars: function (rating, isHover) {
                            var self = this;
                            this.$('label.star').each(function (index) {
                                var starValue = index + 1;
                                var $star = $(this);
                                
                                if (starValue &lt;= rating) {
                                    $star.css({
                                        'filter': 'grayscale(0%)',
                                        'transform': isHover ? 'scale(1.3)' : 'scale(1.2)'
                                    });
                                } else {
                                    $star.css({
                                        'filter': 'grayscale(100%)',
                                        'transform': 'scale(1)'
                                    });
                                }
                            });
                        },
                    });

                    return publicWidget.registry.FeedbackForm;
                });
            </script>
        </t>
    </template>

    <!-- Template de remerciement après feedback -->
    <template id="feedback_thanks_template" name="Merci pour votre Feedback">
        <t t-call="website.layout">
            <!-- Appel des assets -->
        <t t-call="queue_management.queue_assets_common"/>
            <div id="wrap">
                <div class="container mt-4">
                    <div class="row justify-content-center">
                        <div class="col-lg-6 text-center">
                            <i class="fa fa-heart fa-5x text-danger mb-4"/>
                            <h1>Merci pour votre évaluation !</h1>
                            <p class="lead">Votre retour nous aide à améliorer nos services.</p>
                            
                            <div class="card mt-4">
                                <div class="card-body">
                                    <h5>Récapitulatif de votre visite</h5>
                                    <div class="row">
                                        <div class="col-6">
                                            <strong>Service:</strong><br/>
                                            <t t-esc="service.name"/>
                                        </div>
                                        <div class="col-6">
                                            <strong>Ticket:</strong><br/>
                                            #<t t-esc="ticket.ticket_number"/>
                                        </div>
                                    </div>
                                    <div class="row mt-2">
                                        <div class="col-6">
                                            <strong>Temps d'attente:</strong><br/>
                                            <t t-esc="round(ticket.waiting_time, 1)"/> min
                                        </div>
                                        <div class="col-6">
                                            <strong>Votre note:</strong><br/>
                                            <span t-if="ticket.rating == '1'">⭐</span>
                                            <span t-if="ticket.rating == '2'">⭐⭐</span>
                                            <span t-if="ticket.rating == '3'">⭐⭐⭐</span>
                                            <span t-if="ticket.rating == '4'">⭐⭐⭐⭐</span>
                                            <span t-if="ticket.rating == '5'">⭐⭐⭐⭐⭐</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <a href="/queue" class="btn btn-primary mt-4">
                                <i class="fa fa-home"/> Retour à l'accueil
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </t>
    </template>

    <!-- Template de confirmation de ticket avec résultat JavaScript -->
    <template id="ticket_result_template" name="Résultat Ticket">
        <div id="ticket-result" style="display: none;">
            <div class="alert alert-success text-center">
                <h4><i class="fa fa-check-circle"/> Ticket Créé !</h4>
                <div class="row">
                    <div class="col-4">
                        <strong>Ticket:</strong><br/>
                        #<span id="result-ticket-number">-</span>
                    </div>
                    <div class="col-4">
                        <strong>Position:</strong><br/>
                        <span id="result-position">-</span>
                    </div>
                    <div class="col-4">
                        <strong>Attente:</strong><br/>
                        ~<span id="result-wait-time">-</span> min
                    </div>
                </div>
                <div class="mt-3">
                    <a id="track-ticket-link" href="#" class="btn btn-primary btn-sm">
                        <i class="fa fa-search"/> Suivre mon ticket
                    </a>
                </div>
            </div>
        </div>
    </template>

    <!-- Template de recherche de ticket -->
    <template id="ticket_lookup_template" name="Recherche de Ticket">
        <t t-call="website.layout">
            <!-- Appel des assets -->
        <t t-call="queue_management.queue_assets_common"/>
            <div id="wrap">
                <div class="container mt-4">
                    <div class="row justify-content-center">
                        <div class="col-lg-6">
                            <div class="text-center mb-4">
                                <i class="fa fa-search fa-3x text-primary mb-3"/>
                                <h1>Retrouver mon Ticket</h1>
                                <p class="lead">Entrez votre numéro de ticket pour le suivre</p>
                            </div>

                            <div class="card">
                                <div class="card-body">
                                    <form id="lookup-form" method="get">
                                        <div class="mb-3">
                                            <label for="ticket_number" class="form-label">Numéro de Ticket</label>
                                            <input type="number" class="form-control form-control-lg" 
                                                   id="ticket_number" name="ticket_number" 
                                                   placeholder="Ex: 123" required="" min="1"/>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="service_select" class="form-label">Service</label>
                                            <select id="service_select" name="service_id" class="form-select" required="">
                                                <option value="">Sélectionnez un service</option>
                                                <t t-foreach="services" t-as="service">
                                                    <option t-att-value="service.id" t-esc="service.name"/>
                                                </t>
                                            </select>
                                        </div>

                                        <button type="submit" class="btn btn-primary btn-lg w-100">
                                            <i class="fa fa-search"/> Rechercher mon Ticket
                                        </button>
                                    </form>
                                </div>
                            </div>

                            <div class="text-center mt-4">
                                <a href="/queue" class="btn btn-outline-secondary">
                                    <i class="fa fa-arrow-left"/> Retour aux services
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <script>
                document.getElementById('lookup-form').addEventListener('submit', function(e) {
                    e.preventDefault();
                    var ticketNumber = document.getElementById('ticket_number').value;
                    var serviceId = document.getElementById('service_select').value;
                    
                    if (ticketNumber &amp;&amp; serviceId) {
                        window.location.href = '/queue/my_ticket/' + ticketNumber + '/' + serviceId;
                    } else {
                        alert('Veuillez remplir tous les champs');
                    }
                });
            </script>
        </t>
    </template>

    <!-- Template pour état de service fermé -->
    <template id="service_closed_template" name="Service Fermé">
        <t t-call="website.layout">
            <!-- Appel des assets -->
        <t t-call="queue_management.queue_assets_common"/>
            <div id="wrap">
                <div class="container mt-4">
                    <div class="row justify-content-center">
                        <div class="col-lg-6 text-center">
                            <i class="fa fa-clock-o fa-5x text-warning mb-4"/>
                            <h1>Service Fermé</h1>
                            <p class="lead">
                                Le service <strong t-esc="service.name"/> est actuellement fermé.
                            </p>
                            
                            <div class="card mt-4">
                                <div class="card-body">
                                    <h6>Horaires de service :</h6>
                                    <p class="mb-0">
                                        <i class="fa fa-clock-o"/> 
                                        <t t-esc="service.working_hours_start"/>h00 - <t t-esc="service.working_hours_end"/>h00
                                    </p>
                                    
                                    <div t-if="service.break_time_start and service.break_time_end" class="mt-2">
                                        <small class="text-muted">
                                            Pause : <t t-esc="service.break_time_start"/>h - <t t-esc="service.break_time_end"/>h
                                        </small>
                                    </div>
                                    
                                    <div t-if="service.lunch_break_start and service.lunch_break_end" class="mt-1">
                                        <small class="text-muted">
                                            Déjeuner : <t t-esc="service.lunch_break_start"/>h - <t t-esc="service.lunch_break_end"/>h
                                        </small>
                                    </div>
                                </div>
                            </div>
                            
                            <a href="/queue" class="btn btn-primary mt-4">
                                <i class="fa fa-arrow-left"/> Voir les autres services
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </t>
    </template>

    <!-- Template de notification système -->
    <template id="system_notification_template" name="Notification Système">
        <div class="alert alert-dismissible fade show" role="alert">
            <i class="fa fa-bell"/> 
            <strong t-esc="title"/>
            <span t-esc="message"/>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"/>
        </div>
    </template>

    <!-- Template pour les statistiques de service -->
    <template id="service_stats_template" name="Statistiques de Service">
        <t t-call="website.layout">
            <!-- Appel des assets -->
        <t t-call="queue_management.queue_assets_common"/>
            <div id="wrap">
                <div class="container mt-4">
                    <div class="row">
                        <div class="col-12">
                            <h1>
                                <i class="fa fa-bar-chart"/> Statistiques - <span t-esc="service.name"/>
                            </h1>
                            
                            <div class="row mt-4">
                                <div class="col-md-3">
                                    <div class="card text-center">
                                        <div class="card-body">
                                            <h3 class="text-primary" t-esc="stats.total_tickets"/>
                                            <small class="text-muted">Total tickets</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card text-center">
                                        <div class="card-body">
                                            <h3 class="text-success" t-esc="stats.served_tickets"/>
                                            <small class="text-muted">Servis</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card text-center">
                                        <div class="card-body">
                                            <h3 class="text-warning" t-esc="round(stats.avg_waiting_time, 1)"/>
                                            <small class="text-muted">Attente moy. (min)</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card text-center">
                                        <div class="card-body">
                                            <h3 class="text-info" t-esc="round(stats.satisfaction_rate, 1)"/>%
                                            <small class="text-muted">Satisfaction</small>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="row mt-4">
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6>Répartition des tickets</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="progress mb-2">
                                                <div class="progress-bar bg-success" 
                                                     t-attf-style="width: #{stats.served_tickets / stats.total_tickets * 100 if stats.total_tickets else 0}%">
                                                    Servis
                                                </div>
                                                <div class="progress-bar bg-danger" 
                                                     t-attf-style="width: #{stats.cancelled_tickets / stats.total_tickets * 100 if stats.total_tickets else 0}%">
                                                    Annulés
                                                </div>
                                                <div class="progress-bar bg-warning" 
                                                     t-attf-style="width: #{stats.no_show_tickets / stats.total_tickets * 100 if stats.total_tickets else 0}%">
                                                    Absents
                                                </div>
                                            </div>
                                            <small class="text-muted">
                                                Servis: <t t-esc="stats.served_tickets"/> | 
                                                Annulés: <t t-esc="stats.cancelled_tickets"/> | 
                                                Absents: <t t-esc="stats.no_show_tickets"/>
                                            </small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6>Performance</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="mb-2">
                                                <small class="text-muted">Temps de service moyen</small>
                                                <div class="progress">
                                                    <div class="progress-bar bg-info" 
                                                         t-attf-style="width: #{min(stats.avg_service_time / 30 * 100, 100)}%">
                                                        <t t-esc="round(stats.avg_service_time, 1)"/> min
                                                    </div>
                                                </div>
                                            </div>
                                            <div>
                                                <small class="text-muted">Note moyenne du service</small>
                                                <div class="h5">
                                                    <t t-if="service.average_rating > 0">
                                                        <span t-esc="round(service.average_rating, 1)"/>/5 
                                                        <span class="text-warning">
                                                            <t t-foreach="range(int(service.average_rating))" t-as="star">⭐</t>
                                                        </span>
                                                    </t>
                                                    <span t-else="" class="text-muted">Pas encore d'évaluations</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </t>
    </template>

    <!-- Template pour écran d'affichage public -->
    <template id="public_display_template" name="Affichage Public">
        <t t-call="website.layout">
            <!-- Appel des assets -->
        <t t-call="queue_management.queue_assets_common"/>
            <div id="wrap" class="bg-dark text-white">
                <div class="container-fluid py-4">
                    <div class="row mb-4">
                        <div class="col-12 text-center">
                            <h1 class="display-3">
                                <i class="fa fa-desktop"/> Affichage Public
                            </h1>
                            <p class="lead">Files d'attente en temps réel</p>
                        </div>
                    </div>

                    <div class="row">
                        <t t-foreach="services" t-as="service">
                            <div class="col-lg-6 mb-4">
                                <div class="card bg-primary text-white h-100">
                                    <div class="card-header">
                                        <h3 class="mb-0" t-esc="service.name"/>
                                        <span t-if="service.is_open" class="badge bg-success">OUVERT</span>
                                        <span t-else="" class="badge bg-danger">FERMÉ</span>
                                    </div>
                                    <div class="card-body">
                                        <div class="row text-center">
                                            <div class="col-6">
                                                <h1 class="display-4">
                                                    #<span t-esc="service.current_ticket_number"/>
                                                </h1>
                                                <h5>Ticket Actuel</h5>
                                            </div>
                                            <div class="col-6">
                                                <h1 class="display-4 text-warning">
                                                    <span t-esc="service.waiting_count"/>
                                                </h1>
                                                <h5>En Attente</h5>
                                            </div>
                                        </div>
                                        
                                        <div class="mt-4">
                                            <h6>Prochains tickets :</h6>
                                            <div class="next-tickets">
                                                <t t-set="next_tickets" t-value="service.waiting_ticket_ids.sorted('ticket_number')[:5]"/>
                                                <t t-foreach="next_tickets" t-as="ticket">
                                                    <span class="badge bg-light text-dark me-2 mb-2 fs-6">
                                                        #<t t-esc="ticket.ticket_number"/>
                                                    </span>
                                                </t>
                                                <div t-if="not next_tickets" class="text-center py-3">
                                                    <i class="fa fa-check-circle fa-2x"/>
                                                    <p class="mt-2">Aucun ticket en attente</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </t>
                    </div>

                    <div class="row mt-4">
                        <div class="col-12 text-center">
                            <p class="text-light">
                                <i class="fa fa-refresh"/> Mise à jour automatique toutes les 10 secondes
                            </p>
                            <small class="text-muted">
                                Dernière mise à jour : <span id="last-update"></span>
                            </small>
                        </div>
                    </div>
                </div>
            </div>

            <script>
                odoo.define('queue_management.public_display', function (require) {
                    'use strict';

                    var publicWidget = require('web.public.widget');

                    publicWidget.registry.PublicDisplay = publicWidget.Widget.extend({
                        selector: '#wrap',

                        init: function () {
                            this._super.apply(this, arguments);
                            this._updateTimestamp();
                            this._startAutoRefresh();
                        },

                        _updateTimestamp: function () {
                            var now = new Date();
                            var timeString = now.toLocaleTimeString();
                            document.getElementById('last-update').textContent = timeString;
                        },

                        _startAutoRefresh: function () {
                            var self = this;
                            setInterval(function () {
                                window.location.reload();
                            }, 10000); // Refresh toutes les 10 secondes
                        },
                    });

                    return publicWidget.registry.PublicDisplay;
                });
            </script>

            <style>
                body {
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    min-height: 100vh;
                }
                
                .card {
                    backdrop-filter: blur(10px);
                    border: none;
                }
                
                .display-4 {
                    font-weight: bold;
                    text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
                }
                
                .next-tickets .badge {
                    font-size: 1.1em;
                    padding: 8px 12px;
                }
            </style>
        </t>
    </template>

    <template id="ticket_not_found_template" name="Ticket Non Trouvé">
        <t t-call="website.layout">
            <!-- Appel des assets -->
        <t t-call="queue_management.queue_assets_common"/>
            <div id="wrap">
                <div class="container mt-4">
                    <div class="row justify-content-center">
                        <div class="col-lg-6">
                            <div class="text-center">
                                <div class="alert alert-warning">
                                    <i class="fa fa-exclamation-triangle fa-3x mb-3"></i>
                                    <h3>Ticket Non Trouvé</h3>
                                    <p>Le ticket #<span t-esc="ticket_number"/> n'a pas pu être trouvé pour ce service.</p>
                                    <p class="text-muted">
                                        Vérifiez que vous avez utilisé le bon lien ou que le ticket n'a pas expiré.
                                    </p>
                                    <a href="/queue" class="btn btn-primary">
                                        <i class="fa fa-arrow-left"/> Retour aux services
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </t>
    </template>

    <!-- Template pour page de maintenance -->
    <template id="maintenance_template" name="Maintenance">
        <t t-call="website.layout">
            <!-- Appel des assets -->
        <t t-call="queue_management.queue_assets_common"/>
            <div id="wrap">
                <div class="container mt-4">
                    <div class="row justify-content-center">
                        <div class="col-lg-6 text-center">
                            <i class="fa fa-wrench fa-5x text-warning mb-4"/>
                            <h1>Maintenance en Cours</h1>
                            <p class="lead">
                                Le système de files d'attente est temporairement indisponible pour maintenance.
                            </p>
                            <div class="alert alert-info">
                                <i class="fa fa-info-circle"/> 
                                Nous nous excusons pour la gêne occasionnée. Le service sera rétabli sous peu.
                            </div>
                            <a href="/" class="btn btn-primary">
                                <i class="fa fa-home"/> Retour à l'accueil
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </t>
    </template>

    <!-- Template de configuration publique -->
    <template id="public_config_template" name="Configuration Publique">
        <div id="queue-config" class="d-none">
            <script type="application/json">
                {
                    "auto_refresh_interval": 30000,
                    "sound_notifications": true,
                    "show_customer_names": false,
                    "max_display_tickets": 10,
                    "language": "fr"
                }
            </script>
        </div>
    </template>
</odoo>