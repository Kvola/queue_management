<?xml version="1.0" encoding="UTF-8"?>
<templates>
    <t t-name="queue_management.QueueDashboardMain" owl="1">
        <div class="queue-dashboard-container h-100 d-flex flex-column">
            <!-- Header fixe avec menu déroulant -->
            <div class="dashboard-header d-flex justify-content-between align-items-center mb-4 bg-white p-3 border-bottom shadow-sm" style="position: sticky; top: 0; z-index: 100;">
                <div class="d-flex align-items-center">
                    <h2 class="mb-0 me-4">Queue Management Dashboard</h2>
                    
                    <!-- Menu déroulant -->
                    <!-- <div class="dropdown">
                        <button class="btn btn-outline-secondary dropdown-toggle" 
                                type="button" 
                                id="dashboardMenuDropdown" 
                                data-bs-toggle="dropdown" 
                                aria-expanded="false">
                            <i class="fa fa-bars"/> Menu
                        </button>
                        <ul class="dropdown-menu" aria-labelledby="dashboardMenuDropdown">
                            <li>
                                <a class="dropdown-item" href="#" t-on-click="onShowServicesManagement">
                                    <i class="fa fa-cogs"/> Gestion des Services
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="#" t-on-click="onShowAgentsManagement">
                                    <i class="fa fa-users"/> Gestion des Agents
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="#" t-on-click="onShowReports">
                                    <i class="fa fa-chart-line"/> Rapports
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"/></li>
                            <li>
                                <a class="dropdown-item" href="#" t-on-click="onShowSettings">
                                    <i class="fa fa-gear"/> Paramètres
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="#" t-on-click="onExportData">
                                    <i class="fa fa-download"/> Exporter les données
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"/></li>
                            <li>
                                <a class="dropdown-item" href="#" t-on-click="onShowHelp">
                                    <i class="fa fa-question-circle"/> Aide
                                </a>
                            </li>
                        </ul>
                    </div> -->
                </div>
                
                <div class="dashboard-controls">
                    <div class="btn-group" role="group">
                        <button class="btn btn-outline-primary btn-sm" 
                                t-on-click="onRefreshDashboard"
                                t-att-disabled="state.isLoading">
                            <i class="fa fa-refresh"/>
                            Actualiser
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" 
                                t-on-click="onToggleAutoRefresh"
                                t-att-class="{'active': isAutoRefreshEnabled}">
                            <i class="fa fa-clock-o"/>
                            Auto-refresh
                        </button>
                        <button class="btn btn-outline-info btn-sm" 
                                t-on-click="onToggleCharts"
                                t-att-class="{'active': areChartsEnabled}">
                            <i class="fa fa-bar-chart"/>
                            Graphiques
                        </button>
                    </div>
                </div>
            </div>

            <!-- Status Bar fixe -->
            <div class="dashboard-status-bar mb-3 bg-light p-2 border-bottom" style="position: sticky; top: 80px; z-index: 99;">
                <div class="row">
                    <div class="col-md-8">
                        <div class="d-flex align-items-center">
                            <span class="badge" 
                                  t-att-class="'badge-' + getConnectionStatusColor()">
                                <i class="fa fa-circle"/> 
                                <t t-esc="connectionStatus.message"/>
                            </span>
                            <span class="text-muted ms-3" t-if="lastUpdate">
                                Dernière mise à jour: <t t-esc="lastUpdate"/>
                            </span>
                        </div>
                    </div>
                    <div class="col-md-4 text-end">
                        <div class="spinner-border spinner-border-sm text-primary" 
                             role="status" 
                             t-if="state.isLoading">
                            <span class="visually-hidden">Chargement...</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Contenu scrollable -->
            <div class="dashboard-scrollable-content flex-grow-1 overflow-auto px-3" style="height: calc(100vh - 160px);">
                
                <!-- Loading State -->
                <div class="text-center py-5" t-if="state.isLoading and !isDataLoaded">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Chargement du dashboard...</span>
                    </div>
                    <p class="mt-3 text-muted">Chargement du dashboard...</p>
                </div>

                <!-- Dashboard Content -->
                <div t-if="!state.isLoading or isDataLoaded">
                    
                    <!-- Statistics Cards -->
                    <div class="row mb-4">
                        <div class="col-md-3 mb-3">
                            <div class="card text-white bg-primary h-100">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h4 class="card-title mb-0" t-esc="stats.total_tickets"/>
                                            <p class="card-text">Total Tickets</p>
                                        </div>
                                        <div class="align-self-center">
                                            <i class="fa fa-ticket fa-2x"/>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card text-white bg-warning h-100">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h4 class="card-title mb-0" t-esc="stats.waiting_tickets"/>
                                            <p class="card-text">En Attente</p>
                                        </div>
                                        <div class="align-self-center">
                                            <i class="fa fa-clock-o fa-2x"/>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card text-white bg-info h-100">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h4 class="card-title mb-0" t-esc="stats.serving_tickets"/>
                                            <p class="card-text">En Service</p>
                                        </div>
                                        <div class="align-self-center">
                                            <i class="fa fa-user fa-2x"/>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card text-white bg-success h-100">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h4 class="card-title mb-0" t-esc="stats.completed_tickets"/>
                                            <p class="card-text">Terminés</p>
                                        </div>
                                        <div class="align-self-center">
                                            <i class="fa fa-check fa-2x"/>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Charts Section -->
                    <div class="row mb-4" t-if="areChartsEnabled">
                        <div class="col-md-6 mb-3">
                            <div class="card h-100">
                                <div class="card-header">
                                    <h5 class="card-title mb-0">Services</h5>
                                </div>
                                <div class="card-body">
                                    <canvas t-ref="servicesChart" style="height: 300px;"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="card h-100">
                                <div class="card-header">
                                    <h5 class="card-title mb-0">Statistiques</h5>
                                </div>
                                <div class="card-body">
                                    <canvas t-ref="statsChart" style="height: 300px;"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row mb-4" t-if="areChartsEnabled">
                        <div class="col-md-6 mb-3">
                            <div class="card h-100">
                                <div class="card-header">
                                    <h5 class="card-title mb-0">Temps d'Attente</h5>
                                </div>
                                <div class="card-body">
                                    <canvas t-ref="waitingTimeChart" style="height: 300px;"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="card h-100">
                                <div class="card-header">
                                    <h5 class="card-title mb-0">Performance</h5>
                                </div>
                                <div class="card-body">
                                    <canvas t-ref="performanceChart" style="height: 300px;"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Services List -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="card-title mb-0">Services Actifs</h5>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-striped">
                                            <thead class="table-dark sticky-top">
                                                <tr>
                                                    <th>Service</th>
                                                    <th>Statut</th>
                                                    <th>En Attente</th>
                                                    <th>En Service</th>
                                                    <th>Terminés</th>
                                                    <th>Temps d'Attente Moyen</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr t-foreach="dashboardData.services" t-as="service" t-key="service.id">
                                                    <td>
                                                        <strong t-esc="service.name"/>
                                                    </td>
                                                    <td>
                                                        <span class="badge" 
                                                              t-att-class="service.is_open ? 'badge-success' : 'badge-danger'">
                                                            <t t-if="service.is_open">Ouvert</t>
                                                            <t t-else="">Fermé</t>
                                                        </span>
                                                    </td>
                                                    <td>
                                                        <span class="badge badge-warning" t-esc="service.waiting_count"/>
                                                    </td>
                                                    <td>
                                                        <span class="badge badge-info" t-esc="service.serving_count"/>
                                                    </td>
                                                    <td>
                                                        <span class="badge badge-success" t-esc="service.served_count"/>
                                                    </td>
                                                    <td>
                                                        <t t-esc="formatDuration(service.avg_waiting_time)"/>
                                                    </td>
                                                    <td>
                                                        <div class="btn-group btn-group-sm">
                                                            <button class="btn btn-outline-primary" 
                                                                    t-on-click="onGenerateTicket"
                                                                    t-att-data-service-id="service.id">
                                                                <i class="fa fa-plus"/> Ticket
                                                            </button>
                                                            <button class="btn btn-outline-info" 
                                                                    t-on-click="onCallNextFromService"
                                                                    t-att-data-service-id="service.id"
                                                                    t-att-disabled="!service.waiting_count">
                                                                <i class="fa fa-arrow-right"/> Suivant
                                                            </button>
                                                        </div>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tickets Lists -->
                    <div class="row mb-4">
                        <div class="col-md-6 mb-3">
                            <div class="card h-100">
                                <div class="card-header bg-warning text-white sticky-top">
                                    <h5 class="card-title mb-0">Tickets en Attente</h5>
                                </div>
                                <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                                    <div t-if="!dashboardData.waiting_tickets.length" class="text-center text-muted py-3">
                                        <i class="fa fa-inbox fa-2x mb-2"/>
                                        <p>Aucun ticket en attente</p>
                                    </div>
                                    <div t-else="" class="list-group list-group-flush">
                                        <div t-foreach="dashboardData.waiting_tickets" t-as="ticket" t-key="ticket.id" 
                                             class="list-group-item d-flex justify-content-between align-items-center">
                                            <div>
                                                <h6 class="mb-1">
                                                    Ticket #<t t-esc="ticket.number"/>
                                                    <span class="badge" 
                                                          t-att-class="'badge-' + getPriorityColor(ticket.priority)"
                                                          t-esc="ticket.priority"/>
                                                </h6>
                                                <p class="mb-1">
                                                    <strong t-esc="ticket.service_name"/>
                                                </p>
                                                <small class="text-muted">
                                                    <t t-esc="ticket.customer_name"/> - 
                                                    Position: <t t-esc="ticket.position_in_queue"/>
                                                </small>
                                            </div>
                                            <button class="btn btn-primary btn-sm" 
                                                    t-on-click="onCallNext"
                                                    t-att-data-ticket-id="ticket.id">
                                                <i class="fa fa-arrow-right"/> Appeler
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <div class="card h-100">
                                <div class="card-header bg-info text-white sticky-top">
                                    <h5 class="card-title mb-0">Tickets en Service</h5>
                                </div>
                                <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                                    <div t-if="!dashboardData.serving_tickets.length" class="text-center text-muted py-3">
                                        <i class="fa fa-user fa-2x mb-2"/>
                                        <p>Aucun ticket en service</p>
                                    </div>
                                    <div t-else="" class="list-group list-group-flush">
                                        <div t-foreach="dashboardData.serving_tickets" t-as="ticket" t-key="ticket.id" 
                                             class="list-group-item d-flex justify-content-between align-items-center">
                                            <div>
                                                <h6 class="mb-1">
                                                    Ticket #<t t-esc="ticket.number"/>
                                                    <span class="badge badge-info">En service</span>
                                                </h6>
                                                <p class="mb-1">
                                                    <strong t-esc="ticket.service_name"/>
                                                </p>
                                                <small class="text-muted">
                                                    <t t-esc="ticket.customer_name"/> - 
                                                    Agent: <t t-esc="ticket.agent_name"/>
                                                </small>
                                            </div>
                                            <button class="btn btn-success btn-sm" 
                                                    t-on-click="onCompleteService"
                                                    t-att-data-ticket-id="ticket.id">
                                                <i class="fa fa-check"/> Terminer
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Error State -->
                <div class="alert alert-danger mb-4" t-if="state.connectionError and state.retryAttempts >= 3">
                    <h4 class="alert-heading">Erreur de connexion</h4>
                    <p>Impossible de charger les données du dashboard. Vérifiez votre connexion internet.</p>
                    <hr/>
                    <button class="btn btn-outline-danger" t-on-click="onRefreshDashboard">
                        <i class="fa fa-refresh"/> Réessayer
                    </button>
                </div>
            </div>
        </div>
    </t>
</templates>